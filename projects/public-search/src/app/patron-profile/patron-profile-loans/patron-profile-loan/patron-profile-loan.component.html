<!--
  RERO ILS UI
  Copyright (C) 2021-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if(loan()) {
<div class="ui:grid ui:grid-cols-12 ui:gap-4 ui:p-2 ui:pl-1"
  [ngClass]="{'callout callout-warning': loan().metadata.is_late}">
  <!-- DOCUMENT & ADDITIONAL DATA -->
  <div class="ui:md:col-span-8 ui:col-span-12 ui:flex ui:gap-2">
    <shared-open-close-button (status)="isCollapsed.set($event)" />
    <div class="ui:w-full">
      <public-search-patron-profile-document [loan]="loan()" [showAdditionalInformation]="!isCollapsed()">
        <dl class="ui:md:grid ui:grid-cols-4" additional-metadata>
          <dt class="ui:font-bold ui:mr-2" translate>Library</dt>
          <dd class="ui:col-span-3">{{ loan().metadata.library.name }}</dd>
        </dl>
      </public-search-patron-profile-document>
      <dl class="ui:md:hidden">
        <dt translate>Due date</dt>
        <dd [ngClass]="{ 'ui:font-bold text-success': loan()?.actionSuccess}">{{ loan().metadata.end_date |
          dateTranslate :'shortDate' }}</dd>
      </dl>
      <div class="ui:md:hidden">
        <ng-container [ngTemplateOutlet]="tags" />
      </div>
    </div>
  </div>
  <!-- DUE DATE & BADGES -->
  <div class="ui:md:col-span-2 ui:col-span-12 ui:hidden ui:md:block">
    <div>
      <span [ngClass]="{ 'ui:font-bold text-success': loan()?.actionSuccess}">
        {{ loan().metadata.end_date | dateTranslate :'shortDate' }}
      </span>
    </div>
    <ng-container [ngTemplateOutlet]="tags" />
  </div>
  <!-- ACTION BUTTONS COLUMN -->
  <div class="ui:md:col-span-2 ui:col-span-12 ui:flex ui:justify-end">
    <p-button severity="secondary" [outlined]="true" size="small" class="ui:pointer-events-auto"
      [pTooltip]="loan().canExtend?.reasons | arrayTranslate | join:' / '" tooltipPosition="top"
      [tooltipDisabled]="loan().canExtend?.can" (onClick)="store.renewLoan(loan())"
      [disabled]="store.renewInProgress() || loan()?.actionSuccess || !loan().canExtend?.can"
      [label]="loan()?.actionSuccess ? ('Renewed' | translate) : ('Renew' | translate)"
      [icon]="store.renewInProgress()? 'fa fa-spin fa-spinner': loan()?.actionSuccess ? 'fa fa-refresh text-success': 'fa fa-refresh'" />
  </div>
</div>
}

<ng-template #tags>
  @if (loan().metadata.extension_count && loan().metadata.extension_count > 0) {
  <p-tag styleClass="ui:mt-1" severity="secondary">
    {{ loan().metadata.extension_count }}
    {{ loan().metadata.extension_count | i18nPlural: {'=1': 'renewal', 'other': 'renewals'} | translate }}
  </p-tag>
  }
  @if (loan().metadata.overdue) {
  <div class="ui:mt-1">
    <p-tag severity="warn" translate>overdue</p-tag>
  </div>
  }
  @if (isDueSoon()) {
  <p-tag styleClass="ui:mt-1" severity="info" translate>approaching due date</p-tag>
  }
</ng-template>
