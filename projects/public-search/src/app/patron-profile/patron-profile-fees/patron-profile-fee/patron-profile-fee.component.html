<!--
  RERO ILS UI
  Copyright (C) 2021-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (record) {
  <div class="ui:grid ui:grid-cols-12 ui:gap-4 ui:p-2 ui:pl-1">
    <div class="ui:col-span-1">
      <shared-open-close-button (status)="isCollapsed = $event" />
    </div>
    <div class="ui:col-span-11 ui:md:grid ui:md:grid-cols-12 ui:flex-col ui:ml-5 ui:md:ml-0">
      <div class="ui:col-span-2">{{ record.createdAt | dateTranslate: 'short' }}</div>
      <div class="ui:col-span-7">
        <div class="ui:flex ui:flex-col">
          @if (isCollapsed && document) {
            <a href="/{{ organisation.code }}/documents/{{ document.metadata.pid }}">{{ document.metadata.title | mainTitle }}</a>
          }
          <div>
            {{ record.type | translate }}
          </div>
        </div>
      </div>
      <div class="ui:col-span-3 ui:flex ui:justify-start ui:md:justify-end ui:mr-3 ui:font-bold">
        {{ record.totalAmount | currency:organisation.currency:'symbol' }}
      </div>
    </div>

    <!-- FEE DETAILS & EVENTS =========================================== -->
    @if (!isCollapsed) {
      <div class="ui:col-span-11 ui:col-start-2">
          <!-- NOTE -->
          @if (record.notes?.length > 0) {
            @let headerTitle = record.notes.length > 1 ? 'Notes' : 'Note';
            <p-panel styleClass="ui:mb-2 ui:pb-2 ui:bg-transparent" [header]="headerTitle | translate">
              <div class="ui:mx-5">
                <ul>
                  @for (note of record.notes; track $index) {
                    <li>{{ note }}</li>
                  }
                </ul>
              </div>
            </p-panel>
          }
          <!-- DOCUMENT METADATA -->
          @if (document) {
            <p-panel styleClass="ui:mb-2 ui:pb-2 ui:bg-transparent" [header]="'Document' | translate" id="fee-{{ document.metadata.pid }}-document">
              <dl class="metadata ui:mx-5">
                <!-- TITLE -->
                <dt translate>Title</dt>
                <dd>
                  <a href="/{{ organisation.code }}/documents/{{ document.metadata.pid }}">{{ document.metadata.title | mainTitle }}</a>
                </dd>
                <!-- CALL NUMBER -->
                @if (record.loan.item?.call_number) {
                  <dt translate>Call number</dt>
                  <dd>{{ record.loan.item.call_number }}</dd>
                }
                <!-- LOAN DATE -->
                <dt translate>Loan started at</dt>
                <dd>{{ record.loan.start_date | dateTranslate: 'short' }}</dd>
              </dl>
            </p-panel>
          }

          <!-- TRANSACTIONS HISTORY -->
          <p-panel styleClass="ui:bg-transparent  ui:pb-2 time-line-30" [header]="'Transactions history' | translate">

          <public-search-patron-profile-fee-events [events]="record.transactions" />

          @if (record.overdue > 0) {
            <p-timeline [value]="[record]" class="ui:mt-2">
                <ng-template #content let-event>
                    <div class="ui:md:flex">
                      <div class="ui:flex-grow" translate>
                        expected fees
                      </div>
                      <div>
                      <p-tag class="ui:pr-1" severity="danger">
                        {{ event.overdue | currency:organisation.currency:'symbol' }}
                      </p-tag>
                      </div>
                    </div>
                </ng-template>
                <ng-template #opposite  let-event>
                  <div class="ui:text-muted-color ui:text-sm ui:justify-items-end">
                    <div class="ui:md:flex ui:md:flex-row ui:flex-col ui:justify-items-end">
                      <div class="ui:flex ui:gap-1 ui:items-center">
                        <i class="fa fa-calendar-o"></i>
                        {{ event.createdAt | dateTranslate: 'shortDate' }}
                      </div>
                      <div class="ui:flex ui:gap-1 ui:items-center">
                        <i class="fa fa-clock-o ui:pl-1"></i>
                        {{ event.createdAt | dateTranslate: 'HH:mm' }}
                      </div>
                    </div>
                  </div>
                </ng-template>
                <ng-template #marker>
                  <span
                    class="ui:flex ui:items-center ui:justify-center ui:text-white ui:rounded-full ui:z-10 ui:shadow-sm ui:bg-red-500 ui:w-[1.3rem] ui:h-[1.3rem]"
                  >
                    <i class="fa fa-check"></i>
                  </span>
                </ng-template>
            </p-timeline>
          }

          </p-panel>
      </div>
    }
  </div>
}
