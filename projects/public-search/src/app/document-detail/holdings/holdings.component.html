<!--
  RERO ILS UI
  Copyright (C) 2021-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@let isAuthenticated = userService.user.isAuthenticated;

@if(store.filter().length > 1) {
<div class="ui:mb-3">
  <p-multiselect
    [options]="store.filter()"
    optionLabel="name"
    optionValue="pid"
    [fluid]="true"
    [maxSelectedLabels]="2"
    [placeholder]="'Filter by library'|translate"
    (onChange)="store.setLibraryFilter($event)"
  />
</div>
}

@if (store.filteredHoldings().length > 0) {
  @if (!isAuthenticated) {
    <div class="ui:mb-4">
      <p-message
        [text]="'Log in to see request options' | translate"
        severity="warn"
        showTransitionOptions="0ms"
      />
    </div>
  }
  <p-accordion [multiple]="true" [value]="store.filteredHoldings().length === 1 ? [0] : []">
    @for (holding of store.filteredHoldings(); track holding.metadata.pid; let idx = $index) {
      <p-accordion-panel #panel [value]="idx" class="ui:mb-2">
        <p-accordion-header>
          <div class="ui:w-full">
            <div class="ui:grid ui:grid-cols-12 ui:md:gap-4 ui:gap-1 ui:mb-4">
              <div class="ui:col-span-12 ui:md:col-span-5">
                {{ holding.metadata.library.name }}:&nbsp;{{ holding.metadata.location.name }}
              </div>
              <div class="ui:col-span-12 ui:md:col-span-2">
                {{ holding.metadata.circulation_category.circulation_information | getTranslatedLabel : translateService.currentLang }}
              </div>
              <div class="ui:col-span-12 ui:md:col-span-2">
                @if (holding.metadata.public_items_count > 0) {
                  {{ holding.metadata.public_items_count }}
                  {{ holding.metadata.public_items_count | i18nPlural: { '=0': 'item', '=1': 'item', 'other': 'items' } | translate }}
              }
              </div>
              <div class="ui:col-span-12 ui:md:col-span-3">
                @if (holding.metadata.holdings_type === 'serial') {
                    <i class="fa fa-circle text-warning"></i>
                    {{ 'see collections and items' | translate }}
                } @else {
                  <shared-availability recordType="holding" [record]="holding" [apiService]="holdingsApiService" />
                }
              </div>
            </div>
          <!-- SERIAL HOLDING INFORMATION'S -->
          @if (holding.metadata.holdings_type === 'serial') {
            <!-- CALL NUMBER -->
            @if (holding.metadata.call_number) {
              <shared-description-zone>
                <ng-container label translate>Call number</ng-container>
                <ng-container content>
                  <span class="ui:font-normal">
                    {{ holding.metadata.call_number }}
                  @if (holding.metadata.second_call_number) {
                    | {{ holding.metadata.second_call_number }}
                  }
                  </span>
                </ng-container>
              </shared-description-zone>
            }
            <!-- ENUMERATION AND CHRONOLOGY -->
            @if (holding.metadata.enumerationAndChronology) {
              <shared-description-zone>
                <ng-container label translate>Available collection</ng-container>
                <ng-container content>
                  <span class="ui:font-normal" [innerHTML]="holding.metadata.enumerationAndChronology | nl2br"></span>
                </ng-container>
              </shared-description-zone>
            }
            <!-- SUPPLEMENTARY CONTENT -->
            @if (holding.metadata.supplementaryContent) {
              <shared-description-zone>
                <ng-container label translate>Supplementary content</ng-container>
                <ng-container content>
                  <span class="ui:font-normal">{{ holding.metadata.supplementaryContent }}</span>
                </ng-container>
              </shared-description-zone>
            }
            <!-- INDEX -->
            @if (holding.metadata.index) {
              <shared-description-zone>
                <ng-container label translate>Indexes</ng-container>
                <ng-container content>
                  <span class="ui:font-normal">{{ holding.metadata.index }}</span>
                </ng-container>
              </shared-description-zone>
            }
            <!-- MISSING ISSUES -->
            @if (holding.metadata.missing_issues) {
              <shared-description-zone>
                <ng-container label translate>Missing issues</ng-container>
                <ng-container content>
                  <span class="ui:font-normal">{{ holding.metadata.missing_issues }}</span>
                </ng-container>
              </shared-description-zone>
            }
            <!-- NOTE -->
            @if (holding.metadata.notes) {
              @for (note of holding.metadata.notes | notesFilter : noteAuthorizedTypes; track $index) {
                <shared-description-zone>
                  <ng-container label translate>{{ note.type }}</ng-container>
                  <ng-container content>
                    <span class="ui:font-normal" [innerHTML]="note.content | nl2br"></span>
                  </ng-container>
                </shared-description-zone>
              }
            }
          }
        </div>
        </p-accordion-header>
        <p-accordion-content>
          @if (panel.active()) {
            @if (holding.metadata.public_items_count > 0) {
              <public-search-items [holding]="holding" [viewcode]="viewcode" />
            }
            <public-search-request
              [record]="holding"
              recordType="holding"
              [viewcode]="viewcode"
              [holdingsItemsCount]="holding.metadata.public_items_count"
              class="ui:w-full"
              [ngClass]="{'ui:mt-2': holding.metadata.public_items_count === 0}"
            />
          }
        </p-accordion-content>
      </p-accordion-panel>
    }
  </p-accordion>

  <div class="ui:mt-2">
    @if(isAuthenticated && userService.user.hasRoles(['patron']) && viewcode === 'global') {
      <div>
        <a
          pButton
          [outlined]="true"
          size="small"
          icon="fa fa-truck"
          href="/{{ viewcode }}/ill_requests/new?record_pid={{ documentPid }}"
          translate
        >
          Interlibrary loan
        </a>
      </div>
    }
  </div>
}
