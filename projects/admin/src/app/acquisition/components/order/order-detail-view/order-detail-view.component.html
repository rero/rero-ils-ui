<!--
  RERO ILS UI
  Copyright (C) 2019-2024 RERO
  Copyright (C) 2019-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (order && order.pid) {
<div [ngClass]="{ 'opacity-50': !order.is_current_budget }">
  <!-- ROLLOVER INFO -->
  @if (!order.is_current_budget) {
    <p-messages
      [value]="[{ severity: 'warn', detail: 'Fiscal year closed' | translate }]"
      [closable]="false"
      [enableService]="false"
      showTransitionOptions="0ms"
    />
  }

  <!-- Place order button -->
  <div class="flex gap-2 justify-content-between flex-wrap">
    <h1>{{ order.reference }}</h1>
    @if (order?.is_current_budget && order?.pid) {
      @if (recordPermissions && recordPermissions.update.can && order.status === acqOrderStatus.PENDING) {
        <section class="flex justify-content-end">
          <p-button
            (onClick)="placeOrderDialog()"
            severity="primary"
            [disabled]="!canPlaceOrder"
            icon="fa fa-shopping-cart"
            [label]="'Place order' | translate"
          />
        </section>
      }
    }
  </div>
  <!-- ORDER SUMMARY -->
  <admin-order-summary [order]="order">
    @if (order.notes && order.notes.length > 0) {
    <dt translate>Notes</dt>
    <dd>
      @for (note of order.notes; track note) {
      <a href (click)="scrollTo($event, 'notes'); notesCollapsed = false">
        <p-tag severity="{{ note | noteBadgeColor }}">{{
          note.type | translate
        }}</p-tag>
      </a>
      }
    </dd>
    }
  </admin-order-summary>

  <p-tabView [activeIndex]="tabActiveIndex" (activeIndexChange)="addTabToUrl($event)">
    <p-tabPanel #orderPanel [header]="'Order' | translate">
      <!--- TODO: change this for the next primeng version (19)-->
      @if(orderPanel.selected) {
        <div class="flex flex-column gap-2">
          <!-- ORDER LINES -->
          <admin-order-lines
            [order]="order"
          />
          <!-- ORDER NOTES -->
          @if(order.notes && order.notes.length > 0) {
            <p-panel>
              <ng-template pTemplate="header">
                <div class="flex gap-2 align-items-center">
                  <shared-open-close-button (status)="notesCollapsed = $event" />
                  <h5 class="m-0">
                    {{
                      order.notes.length
                        | i18nPlural : { "=1": "Note", other: "Notes" }
                        | translate
                    }}&nbsp;
                    <p-badge [value]="order.notes.length" />
                  </h5>
                </div>
              </ng-template>

              @if (!notesCollapsed) {
              <admin-notes [notes]="order.notes" />
              }
            </p-panel>
          }
        </div>
      }
    </p-tabPanel>
    <p-tabPanel
      id="receipt"
      [header]="'Reception' | translate"
      [disabled]="disabledReceipts"
      #receiptPanel
    >
      @if (receiptPanel.selected) {
        <admin-receipt-list
          [order]="order"
        />
      }
    </p-tabPanel>
    @if (historyVersions && historyVersions.length > 1) {
      <p-tabPanel [header]="'History' | translate">
        <p-timeline [value]="historyVersions">
          <ng-template pTemplate="opposite" let-event>
            <a [routerLink]="['/records', 'acq_orders', 'detail', event.pid]">{{
              event.label
            }}</a>
          </ng-template>
          <ng-template pTemplate="content" let-event>
            <small>{{ event.description }}</small>
          </ng-template>
        </p-timeline>
      </p-tabPanel>
    }
  </p-tabView>
</div>
}
