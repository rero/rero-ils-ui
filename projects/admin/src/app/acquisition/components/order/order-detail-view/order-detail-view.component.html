<!--
  RERO ILS UI
  Copyright (C) 2019-2025 RERO
  Copyright (C) 2019-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@if (order && order.pid) {
<div [ngClass]="{ 'opacity-50': !order.is_current_budget }">
  <!-- ROLLOVER INFO -->
  @if (!order.is_current_budget) {
    <p-message
      [text]="'Fiscal year closed' | translate"
      severity="warn"
      showTransitionOptions="0ms"
    />
  }

  <!-- Place order button -->
  <div class="flex gap-2 justify-between flex-wrap">
    <h1>{{ order.reference }}</h1>
    @if (order?.is_current_budget && order?.pid) {
      @if (recordPermissions && recordPermissions.update.can && order.status === acqOrderStatus.PENDING) {
        <section class="flex justify-end">
          <p-button
            (onClick)="placeOrderDialog()"
            severity="primary"
            [disabled]="!canPlaceOrder"
            icon="fa fa-shopping-cart"
            [label]="'Place order' | translate"
          />
        </section>
      }
    }
  </div>
  <!-- ORDER SUMMARY -->
  <admin-order-summary [order]="order">
    @if (order.notes && order.notes.length > 0) {
    <dt translate>Notes</dt>
    <dd>
      @for (note of order.notes; track note) {
      <a href (click)="scrollTo($event, 'notes'); notesCollapsed = false">
        <p-tag [severity]="note | noteBadgeColor">
          {{ note.type | translate }}
        </p-tag>
      </a>
      }
    </dd>
    }
  </admin-order-summary>

  <p-tabs class="mt-3" [(value)]="tabActiveIndex">
    <p-tablist>
      <p-tab value="order" translate>Order</p-tab>
      <p-tab value="reception" [disabled]="disabledReceipts" translate>Reception</p-tab>
      <p-tab value="history" translate>History</p-tab>
    </p-tablist>
    <p-tabpanels>
      <p-tabpanel value="order">
        <div class="flex flex-col gap-2">
          <p-accordion [multiple]="true" [value]="['lines']">
            <p-accordion-panel value="lines">
              <p-accordion-header>
                <div class="w-full flex justify-between gap-2 pr-3">
                  <span class="text-bold text-xl" translate>Order lines</span>
                  @if (canAddLine) {
                    <p-button
                      (click)="$event.stopPropagation()"
                      icon="fa fa-plus-square-o"
                      size="small"
                      [outlined]="true"
                      [label]="'Add' | translate"
                      [routerLink]="['/acquisition', 'records', 'acq_order_lines', 'new']"
                      [queryParams]="{ order: order.pid }"
                    />
                  }
                </div>
                <ng-template #tooltipContent>
                  <span [innerHTML]="createInfoMessage | nl2br"></span>
                </ng-template>
              </p-accordion-header>
              <p-accordion-content>
                <admin-order-lines [order]="order" />
              </p-accordion-content>
            </p-accordion-panel>
            <p-accordion-panel value="notes">
              <p-accordion-header>
                <div class="w-full flex mr-2 items-center">
                 @let orderNotesSize = order.notes?.length || 0;
                  <span class="flex-grow text-bold text-xl">
                    {{ orderNotesSize | i18nPlural : { "=0": "Note", "=1": "Note", other: "Notes" } | translate }}
                  </span>
                  <p-badge [value]="orderNotesSize" />
                </div>
              </p-accordion-header>
              <p-accordion-content>
                <div class="mt-2">
                  <admin-notes [notes]="order.notes" />
                </div>
              </p-accordion-content>
            </p-accordion-panel>
          </p-accordion>
        </div>
      </p-tabpanel>
      <p-tabpanel value="reception">
        <admin-receipt-list [order]="order" [recordPermissions]="recordPermissions" />
      </p-tabpanel>
      <p-tabpanel value="history">
        <p-timeline [value]="historyVersions">
          <ng-template #opposite let-event>
            <a [routerLink]="['/acquisition', 'records', 'acq_orders', 'detail', event.pid]">{{
              event.label
            }}</a>
          </ng-template>
          <ng-template #content let-event>
            <small>{{ event.description }}</small>
          </ng-template>
        </p-timeline>
      </p-tabpanel>
    </p-tabpanels>
  </p-tabs>
</div>
}
