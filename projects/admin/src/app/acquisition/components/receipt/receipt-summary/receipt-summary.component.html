<!--
  RERO ILS UI
  Copyright (C) 2021-2024 RERO
  Copyright (C) 2021-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<div class="grid grid-nogutter border-bottom-1 surface-border pt-2">
  @if (receipt) {
    <!-- RECEIPT INFORMATION COLUMN -->
    <div class="col">
      <div class="grid">
        <!-- FIRST ROW :: receipt detail (always visible) -->
        <div class="col-9 flex flex-wrap gap-2 align-items-center border-bottom-1 surface-border">
          @if (collapsable) {
            <shared-open-close-button (status)="isCollapsed = $event" />
          }
          <div class="flex-grow-1 flex gap-2 align-items-center">
          <label>
            {{ receipt.reference }}
            @if (receipt | receptionDates; as reception_dates) {
              <span class="font-italic text-sm">
                ({{ reception_dates.join(', ') }})
              </span>
            }
          </label>
          @if (receipt.notes.length > 0 && isCollapsed) {
            <span class="flex gap-1">
              @for (note of receipt.notes; track note) {
                <i class="fa fa-circle fa-bullet text-{{ note | noteBadgeColor }}" aria-hidden="true" title="{{ note.type | translate }}"></i>
              }
            </span>
          }
        </div>
          @if (receipt.quantity) {
              <p-tag severity="info">
                <i class="fa fa-sign-in"></i>&nbsp;
                {{ receipt.quantity }}
                {{ receipt.quantity | i18nPlural: {'=1': 'item', 'other': 'items'} | translate }}
              </p-tag>
          }
        </div>
        <div class="col-3 flex border-left-1 border-bottom-1 surface-border font-bold justify-content-end align-items-center" [class.border-right-1]="recordPermissions && allowActions">
          {{ receipt.total_amount | currency:receipt.currency:'symbol' }}
        </div>
        @if (!collapsable || !isCollapsed) {
          <!-- RECEPTION LINES ROWS :: One line for each reception line -->
          @for (line of receipt.receipt_lines; track line) {
            <div class="col-9 flex gap-2 flex-wrap">
              <strong>{{ line.quantity }}</strong>&nbsp;x
              <div>
                @if (line.document.pid | getRecord: 'documents' | async; as document) {
                  <shared-document-brief-view [record]="$any(document).metadata" />
                }
                @if ($any(line).acq_account.pid | getRecord: 'acq_accounts' | async; as account) {
                  <span class="font-bold text-color-secondary text-sm">[{{ $any(account).metadata.number }}]</span>
                }
              </div>
            </div>
            <div class="col-3 flex flex-column gap-2 align-items-end border-left-1 surface-border" [class.border-right-1]="recordPermissions && allowActions">
              <div class="font-bold">{{ line | receiptLineTotalAmount | currency:receipt.currency:'symbol' }}</div>
              <div class="text-sm text-color-secondary">
                {{ line.quantity }} x {{ line.amount | currency:receipt.currency:'symbol' }}
                @if (line.vat_rate) {
                  + {{ line.vat_rate }}%
                }
              </div>
            </div>
          }
          <!-- RECEIPT ADJUSTMENTS :: One line for each adjustment -->
          @for (adjustment of receipt.amount_adjustments; track adjustment) {
            <div class="col-9">
              <i class="fa fa-long-arrow-right mr-3"></i>
              {{ adjustment.label }}
            </div>
            <div class="col-3 flex-column font-bold flex align-items-end border-left-1 surface-border" [class.border-right-1]="recordPermissions && allowActions">
              <div>
                {{ adjustment.amount | currency:receipt.currency:'symbol' }}
              </div>
            </div>
          }
          <!-- RECEIPT NOTES -->
           <div class="col-9">
           <admin-notes [notes]="receipt.notes" />
          </div>
          <div class="col-3 border-left-1 surface-border" [class.border-right-1]="recordPermissions && allowActions">&nbsp;</div>
        }
      </div>
    </div>
    <!-- ACTION BUTTON COLUMN -->
    @if (recordPermissions && allowActions) {
      <div class="col-3 flex flex-wrap gap-1 justify-content-end">
        <!-- CONTINUE BUTTON -->
        <shared-action-button
          icon="fa fa-pencil"
          [title]="'Edit' | translate"
          [disabled]="!recordPermissions.update.can"
          [routerLink]="['/', 'acquisition', 'acq_orders', receipt.acq_order.pid, 'receive']"
          [queryParams]="{ receipt: receipt.pid }"
          [message]="editInfoMessage"
        />
        <shared-action-button
          icon="fa fa-trash"
          [title]="'Delete' | translate"
          severity="danger"
          [disabled]="!recordPermissions.delete.can"
          [message]="deleteInfoMessage"
          (btnClick)="deleteReceipt()"
        />
      </div>
    }
  } @else {
    <i class="fa fa-spin fa-spinner"></i>&nbsp;{{ 'Loading in progressâ€¦' | translate }}
  }
</div>
