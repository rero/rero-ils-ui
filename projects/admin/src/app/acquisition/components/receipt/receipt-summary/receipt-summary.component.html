<!--
  RERO ILS UI
  Copyright (C) 2021-2024 RERO
  Copyright (C) 2021-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<div class="grid grid-cols-12 gap-4 border border-surface rounded-md my-2 p-2">
  @if (receipt) {
    <!-- RECEIPT INFORMATION COLUMN -->
    <div class="col-span-10">
      <div class="grid grid-cols-12 gap-4">
        <!-- FIRST ROW :: receipt detail (always visible) -->
        <div class="col-span-9 flex flex-wrap gap-2 items-center">
          @if (collapsable) {
            <shared-open-close-button (status)="isCollapsed = $event" />
          }
          <div class="grow flex gap-2 items-center">
          <label>
            {{ receipt.reference }}
            @if (receipt | receptionDates; as reception_dates) {
              <span class="italic text-sm">
                ({{ reception_dates.join(', ') }})
              </span>
            }
          </label>
          @if (receipt.notes.length > 0 && isCollapsed) {
            <span class="flex gap-1">
              @for (note of receipt.notes; track note) {
                <i class="fa fa-circle fa-bullet text-{{ note | noteBadgeColor }}" aria-hidden="true" title="{{ note.type | translate }}"></i>
              }
            </span>
          }
        </div>
          @if (receipt.quantity) {
              <p-tag severity="info">
                <i class="fa fa-sign-in"></i>&nbsp;
                {{ receipt.quantity }}
                {{ receipt.quantity | i18nPlural: {'=1': 'item', 'other': 'items'} | translate }}
              </p-tag>
          }
        </div>
        <div class="col-span-3 flex font-bold justify-end items-center" [class.border-right-1]="recordPermissions && allowActions">
          {{ receipt.total_amount | currency:receipt.currency:'symbol' }}
        </div>
        @if (!collapsable || !isCollapsed) {
          <!-- RECEPTION LINES ROWS :: One line for each reception line -->
          @for (line of receipt.receipt_lines; track line) {
            <div class="col-span-9 flex gap-2 flex-wrap">
              <strong>{{ line.quantity }}</strong>&nbsp;x
              <div>
                @if (line.document.pid | getRecord: 'documents' | async; as document) {
                  <shared-document-brief-view [record]="$any(document).metadata" />
                }
                @if ($any(line).acq_account.pid | getRecord: 'acq_accounts' | async; as account) {
                  <span class="font-bold text-muted-color text-sm">[{{ $any(account).metadata.number }}]</span>
                }
              </div>
            </div>
            <div class="col-span-3 flex flex-col gap-2 items-end" [class.border-right-1]="recordPermissions && allowActions">
              <div class="font-bold">{{ line | receiptLineTotalAmount | currency:receipt.currency:'symbol' }}</div>
              <div class="text-sm text-muted-color">
                {{ line.quantity }} x {{ line.amount | currency:receipt.currency:'symbol' }}
                @if (line.vat_rate) {
                  + {{ line.vat_rate }}%
                }
              </div>
            </div>
          }
          <!-- RECEIPT ADJUSTMENTS :: One line for each adjustment -->
          @for (adjustment of receipt.amount_adjustments; track adjustment) {
            <div class="col-span-9">
              <i class="fa fa-long-arrow-right mr-4"></i>
              {{ adjustment.label }}
            </div>
            <div class="col-span-3 flex-col font-bold flex items-end" [class.border-right-1]="recordPermissions && allowActions">
              <div>
                {{ adjustment.amount | currency:receipt.currency:'symbol' }}
              </div>
            </div>
          }
          <!-- RECEIPT NOTES -->
          @if (receipt.notes.length > 0) {
            <div class="col-span-9">
              <admin-notes [notes]="receipt.notes" />
            </div>
            <div class="col-span-3" [class.border-right-1]="recordPermissions && allowActions">&nbsp;</div>
          }
        }
      </div>
    </div>
    <!-- ACTION BUTTON COLUMN -->
    @if (recordPermissions && allowActions) {
      <div class="col-span-2 flex flex-wrap gap-1 justify-end">
        <!-- CONTINUE BUTTON -->
         @if (canEdit) {
          <shared-action-button
            icon="fa fa-pencil"
            [title]="'Edit' | translate"
            [routerLink]="['/', 'acquisition', 'records', 'acq_orders', 'receive', receipt.acq_order.pid]"
            [queryParams]="{ receipt: receipt.pid }"
          />
         }
        <shared-action-button
          icon="fa fa-trash"
          [title]="'Delete' | translate"
          severity="danger"
          [disabled]="!recordPermissions.delete.can"
          [message]="deleteInfoMessage"
          (btnClick)="deleteReceipt()"
        />
      </div>
    }
  } @else {
    <div class="my-3">
      <i class="fa fa-spinner animate-spin"></i>&nbsp;{{ "Loading in progressâ€¦" | translate }}
    </div>
  }
</div>
