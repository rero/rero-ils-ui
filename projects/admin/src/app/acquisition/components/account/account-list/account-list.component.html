<!--
  RERO ILS UI
  Copyright (C) 2021-2024 RERO
  Copyright (C) 2021-2022 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@if (organisation) {
  <header class="flex items-baseline justify-between">
    <h1 translate>Acquisition accounts</h1>
    <div class="flex gap-2 flex-wrap">
      <!-- ADD BUTTON -->
      <p-button
        icon="fa fa-plus"
        [label]="'Add'|translate"
        [routerLink]="['/acquisition', 'records', 'acq_accounts', 'new']"
        [queryParams]="{ budget: organisation.current_budget_pid }"
        [permissions]="permissions.ACAC_CREATE"
      />
      <!-- END ADD BUTTON -->
      <!-- EXPORT BUTTON -->
      <ng-core-export-button
        [exportOptions]="exportOptions"
      />
      <!-- END EXPORT BUTTON -->
      <!-- TRANSFER BUTTON -->
      <p-button
        icon="fa fa-exchange"
        outlined
        [label]="'Transfer funds'|translate"
        [routerLink]="['/', 'acquisition', 'accounts', 'transfer']"
        [permissions]="permissions.ACAC_TRANSFER"
      />
      <!-- END TRANSFER BUTTON -->
    </div>
  </header>

  <section>
    @if (rootAccounts.length > 0) {
      <div class="flex flex-wrap gap-1 my-4">
        <p-button size="small" outlined icon="fa fa-plus" [label]="'Expand all' | translate" (onClick)="expandAll()" />
        <p-button size="small" outlined icon="fa fa-minus" [label]="'Collapse all' | translate" (onClick)="collapseAll()" />
    </div>
    <p-treeTable autoLayout styleClass="p-treetable-sm" [value]="rootAccounts">
      <ng-template #header>
        <tr>
          <th translate>Name</th>
          <th class="text-right" translate>Amount</th>
          <th class="text-right" translate>Available</th>
          <th class="text-right" translate>Engagement</th>
          <th class="text-right" translate>Expenditure</th>
          <th class="text-right" translate>Balance</th>
          <th></th>
        </tr>
    </ng-template>
    <ng-template #body let-rowNode let-rowData="rowData">
      <tr>
          <td>
              <p-treeTableToggler [rowNode]="rowNode" />
              <a [title]="rowData.number" [routerLink]="['/acquisition', 'records', 'acq_accounts', 'detail', rowData.pid]">{{ rowData.name }}</a>
          </td>
          <td  class="text-right">
            {{ rowData.allocated_amount | currency: organisation.default_currency }}
          </td>
          <td class="text-right">
            <ng-container *ngVar="rowData | accountAvailableAmount as available_amount">
              <span [class]="{
                'text-success': available_amount > 0,
                'text-muted-color': available_amount === 0,
                'text-warning': available_amount < 0
              }">
                {{ available_amount | currency: organisation.default_currency }}
              </span>
            </ng-container>
          </td>
          <td class="text-right" [class]="{
            'text-error': rowData.encumbrance_amount.self > 0,
            'text-muted-color': rowData.encumbrance_amount.self <= 0
          }">
              {{ rowData.encumbrance_amount.self | currency: organisation.default_currency }}
          </td>
          <td class="text-right" [class]="{
            'text-error': rowData.expenditure_amount.self > 0,
            'text-muted-color': rowData.expenditure_amount.self <= 0
          }">
          {{ rowData.expenditure_amount.self | currency: organisation.default_currency}}
          </td>
          <td
          class="text-right"
          [class]="{
          'text-muted-color': rowData.remaining_balance.self === 0,
          'text-warning': rowData.remaining_balance.self < 0
        }">
        {{ rowData.remaining_balance.self | currency: organisation.default_currency }}
          </td>
          <td>
            <div class="flex gap-1 justify-end flex-wrap">
             <!-- EDIT BUTTON -->
             @if (rowData.permissions && rowData.permissions?.update && rowData?.permissions?.update?.can) {
              <p-button
                icon="fa fa-pencil"
                outlined
                size="small"
                [title]="'Edit account'|translate"
                [routerLink]="['/acquisition', 'records', 'acq_accounts', 'edit', rowData.pid]"
              />
            }
            <!-- DELETE BUTTON -->
            <p-button
              icon="fa fa-trash"
              class="pointer-events-auto"
              severity="danger"
              outlined
              size="small"
              (onClick)="accountDelete(rowNode)"
              [title]="'Delete account'|translate"
              [pTooltip]="tooltipContent"
              tooltipPosition="top"
              [disabled]="!rowData.permissions?.delete?.can"
              [tooltipDisabled]="rowData.permissions?.delete?.can"
            />
            <ng-template #tooltipContent>
              <span [innerHTML]="deleteInfoMessage(rowData.permissions) | nl2br"></span>
            </ng-template>
          </div>
          </td>
      </tr>
  </ng-template>

    </p-treeTable>

    } @else {
      {{ 'No account available' | translate }}
    }
  </section>
}

