<!--
  RERO ILS UI
  Copyright (C) 2021-2024 RERO
  Copyright (C) 2021 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (accountsToDisplay && organisation) {
  <div class="flex flex-wrap gap-2 justify-between">
    <h1 translate>Fund transfer</h1>
    @if (budgets.length > 1) {
      <p-select (onChange)="selectBudget($event)" [ngModel]="selectedBudget" [options]="budgets">
        <ng-template #selectedItem>
          {{
            selectedBudget.code | getRecord : "budgets" : "field" : "name" | async
          }}
        </ng-template>
        <ng-template #item let-budget>
          {{ budget.code | getRecord : "budgets" : "field" : "name" | async }}
        </ng-template>
      </p-select>
    }
  </div>
  <form class="mt-3" [formGroup]="form" (ngSubmit)="submit()">
    <p-card class="p-card-body-p-0">
      <ng-template #header>
      <div class="grid grid-cols-12 bg-surface-100 p-2 text-lg font-bold">
        <div class="col-span-1 text-center" translate>Source</div>
        <div class="col-span-8 text-right" translate>Amount</div>
        <div class="col-span-2 text-right" translate>Available</div>
        <div class="col-span-1 text-center" translate>Target</div>
      </div>
    </ng-template>
      <div class="mt-4">
        @if (accountsToDisplay.length > 0) {
          @for (account of accountsToDisplay; track account) {
            <div class="grid grid-cols-12 py-1 odd:bg-surface-50">
              <div class="col-span-1 text-center">
                @if (!(form.get('target').value &&
                    form.get('target').value.pid === account.pid)) {
                  <p-radioButton
                    name="source"
                    formControlName="source"
                    [value]="account"
                  />
                }
              </div>
              <div class="col-span-6">
                <a class="depth-padding-{{ account.depth }}" [routerLink]="['/acquisition', 'records', 'acq_accounts', 'detail', account.pid]">{{ account.name }}</a>
              </div>
              <div class="col-span-2 text-right">
                {{
                  account.allocated_amount | currency : organisation.default_currency
                }}
              </div>
              <div
                class="col-span-2 text-right"
                [class]="{
                  'text-success': account.remaining_balance.self > 0,
                  'text-muted-color': account.remaining_balance.self === 0,
                  'text-warning': account.remaining_balance.self < 0
                }"
              >
                {{
                  account.remaining_balance.self
                    | currency : organisation.default_currency
                }}
              </div>
              <div class="col-span-1 text-center">
                @if(!(form.get('source').value &&
                    form.get('source').value.pid === account.pid)) {
                <p-radioButton
                  name="target"
                  formControlName="target"
                  [value]="account"
                />
                }
            </div>
          </div>
        }
        } @else {
          {{ "No account available" | translate }}
        }
      </div>
      <ng-template #footer>
        <div class="flex flex-col gap-1 py-4 px-6 pb-6 mt-2 border-t border-surface">
          <label for="amount" translate>Amount</label>
          <div class="flex flex-wrap gap-2 justify-between">
            <div>
              <p-inputGroup>
                <p-inputGroupAddon>{{ currencySymbol }}</p-inputGroupAddon>
                <input
                  pInputText
                  type="number"
                  id="amount"
                  formControlName="amount"
                  [class]="{ 'ng-invalid ng-dirty': checkInput('amount') }"
                />
              </p-inputGroup>
            </div>
            <div class="flex flex-wrap gap-1 justify-end">
              <p-button
                type="cancel"
                [label]="'Cancel' | translate"
                severity="danger"
                [routerLink]="['/acquisition', 'accounts']"
                outlined
              />
              <p-button
                type="submit"
                [label]="'Transfer' | translate"
                [disabled]="form.invalid"
              />
            </div>
          </div>
          @if (checkInput('amount')) {
            @if (form.get('amount').hasError('required')) {
              <small class="text-error" translate>This field is required.</small>
            }
            @if (form.get('amount').hasError('min')) {
              <small class="text-error">
                {{ "Minimum amount is" | translate }}
                {{ form.get("amount").errors.min.min }}.
              </small>
            }
            @if (form.get('amount').hasError('max')) {
              <small class="text-error">
                {{ "Maximum amount is" | translate }}
                {{ form.get("amount").errors.max.max }}.
              </small>
            }
          }
        </div>
      </ng-template>
    </p-card>
  </form>
}
