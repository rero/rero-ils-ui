<!--
  RERO ILS UI
  Copyright (C) 2021-2024 RERO
  Copyright (C) 2021 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (accountsToDisplay && organisation) {
  <div class="flex flex-wrap gap-2 justify-content-between">
    <h1 translate>Fund transfer</h1>
    @if (budgets.length > 1) {
      <p-dropdown
        (onChange)="selectBudget($event)"
        [ngModel]="selectedBudget"
        [options]="budgets"
      >
        <ng-template pTemplate="selectedItem">
          {{
            selectedBudget.code | getRecord : "budgets" : "field" : "name" | async
          }}
        </ng-template>
        <ng-template let-budget pTemplate="item">
          {{ budget.code | getRecord : "budgets" : "field" : "name" | async }}
        </ng-template>
      </p-dropdown>
    }
  </div>
  <form [formGroup]="form" (ngSubmit)="submit()">
    <p-card class="p-card-body-p-0">
      <ng-template pTemplate="header">
      <div class="hidden md:flex grid grid-nogutter bg-blue-900 text-white p-2 text-lg font-bold">
        <div class="col-1 text-center" translate>Source</div>
        <div class="col-offset-6 col-2 text-right" translate>Amount</div>
        <div class="col-2 text-right" translate>Available</div>
        <div class="col-1 text-center" translate>Target</div>
      </div>
    </ng-template>
      <div class="mt-3">
        @if (accountsToDisplay.length > 0) {
          @for (account of accountsToDisplay; track account) {
            <div class="grid grid-nogutter-x">
              <div class="col-1 text-center">
                @if (!(form.get('target').value &&
                    form.get('target').value.pid === account.pid)) {
                  <p-radioButton
                    name="source"
                    formControlName="source"
                    [value]="account"
                  />
                }
              </div>
              <div class="col-6 ">
                <a class="depth-padding-{{ account.depth }}" [routerLink]="['/', 'records', 'acq_accounts', 'detail', account.pid]">{{ account.name }}</a>
              </div>
              <div class="col-2 text-right">
                {{
                  account.allocated_amount | currency : organisation.default_currency
                }}
              </div>
              <div
                class="col-2 text-right"
                [class]="{
                  'text-success': account.remaining_balance.self > 0,
                  'text-color-secondary': account.remaining_balance.self === 0,
                  'text-warning': account.remaining_balance.self < 0
                }"
              >
                {{
                  account.remaining_balance.self
                    | currency : organisation.default_currency
                }}
              </div>
              <div class="col-1 text-center">
                @if(!(form.get('source').value &&
                    form.get('source').value.pid === account.pid)) {
                <p-radioButton
                  name="target"
                  formControlName="target"
                  [value]="account"
                />
                }
            </div>
          </div>
        }
        } @else {
          {{ "No account available" | translate }}
        }
      </div>
      <ng-template pTemplate="footer">
        <p-divider />
        <div class="flex flex-column gap-2 px-4 pb-4">
          <label for="amount" translate>Amount</label>
          <div class="flex flex-wrap gap-2 justify-content-between">
            <div>
              <p-inputGroup>
                <p-inputGroupAddon>{{ currencySymbol }}</p-inputGroupAddon>
                <input
                  pInputText
                  type="number"
                  id="amount"
                  formControlName="amount"
                  [class]="{ 'ng-invalid ng-dirty': checkInput('amount') }"
                />
              </p-inputGroup>
            </div>
            <div class="flex flex-wrap gap-1 justify-content-end">
              <p-button
                type="cancel"
                [label]="'Cancel' | translate"
                severity="danger"
                [routerLink]="['/acquisition', 'accounts']"
                outlined
              />
              <p-button
                type="submit"
                [label]="'Transfer' | translate"
                [disabled]="form.invalid"
              />
            </div>
          </div>
          @if (checkInput('amount')) {
            @if (form.get('amount').hasError('required')) {
              <small class="text-error" translate>This field is required.</small>
            }
            @if (form.get('amount').hasError('min')) {
              <small class="text-error">
                {{ "Minimum amount is" | translate }}
                {{ form.get("amount").errors.min.min }}.
              </small>
            }
            @if (form.get('amount').hasError('max')) {
              <small class="text-error">
                {{ "Maximum amount is" | translate }}
                {{ form.get("amount").errors.max.max }}.
              </small>
            }
          }
        </div>
      </ng-template>
    </p-card>
  </form>
}
