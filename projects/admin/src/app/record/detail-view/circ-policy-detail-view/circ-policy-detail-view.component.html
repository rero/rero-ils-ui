<!--
  RERO ILS UI
  Copyright (C) 2019-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (record) {
  <header>
    <h1 class="mb-3">{{ record.metadata.name | translate }}</h1>
  </header>
  <article>
    <!-- DETAILS -->
    <section class="m-2 p-2">
      <dl class="metadata">
        <dt translate>Name</dt>
        <dd id="cipo-name">{{ record.metadata.name }}</dd>
        @if (record.metadata.description) {
          <dt translate>Description</dt>
          <dd id="cipo-description">{{ record.metadata.description }}</dd>
        }
        <dt translate>Level</dt>
        <dd id="cipo-level">
          @if (record.metadata.policy_library_level) {
            {{ 'Library' | translate }}
            <ul class="list-none m-0 p-0">
              @for (library of record.metadata.libraries; track library) {
                <li>
                  <i class="fa fa-university"></i>&nbsp;
                  {{ library.pid | getRecord: 'libraries' : 'field' : 'name' | async }}
                </li>
              }
            </ul>
          } @else {
            {{ 'Organisation' | translate }}
          }
        </dd>
      </dl>
    </section>

    <!-- CIRCULATION SETTINGS -->
    <section class="mt-3">
      <p-fieldset [legend]="'Circulation settings'|translate">
        <dl class="metadata">
          <!-- IS DEFAULT -->
          <dt translate>Is default</dt>
          <dd>
            @if (record.metadata.is_default) {
              <i id="cipo-is-default" class="fa fa-check  text-success" aria-hidden="true"></i>
            } @else {
              <i id="cipo-is-default" class="fa fa-times text-danger" aria-hidden="true"></i>
            }
          </dd>
          <!-- CHECKOUT SETTINGS-->
          <dt translate>Allow checkout</dt>
          @if (checkoutIsAllowed) {
            <dd class="flex gap-2">
              <i id="cipo-allow-checkout" class="fa fa-check text-success" aria-hidden="true"></i>
            <dl class="metadata" style="padding-top: 0 !important;">
            <dt translate>Checkout duration</dt>
            <dd id="cipo-checkout-duration">
              {{ record.metadata.checkout_duration }}
              {{ record.metadata.checkout_duration | i18nPlural: {'=1': 'day', 'other': 'days'} | translate }}
            </dd>
            <dt translate>Number of renewals</dt>
            <dd id="cipo-cnumber-renewals">
              {{ record.metadata.number_renewals }}
            </dd>
            <dt translate>Renewal duration</dt>
            <dd id="cipo-renewal-duration">
              {{ record.metadata.renewal_duration }}
              {{ record.metadata.renewal_duration | i18nPlural: {'=1': 'day', 'other': 'days'} | translate }}
            </dd>
            <dt translate>Automatic renewal</dt>
            <dd id="cipo-auto-renewal">
              @if (record.metadata.automatic_renewal) {
                <i class="fa fa-check text-success" aria-hidden="true"></i>
              } @else {
                <i class="fa fa-times text-danger" aria-hidden="true"></i>
              }
            </dd>
            </dl>
            </dd>
          } @else {
            <dd>
              <i id="cipo-allow-checkout" class="fa fa-times text-danger" aria-hidden="true"></i>
            </dd>
          }
          <dt translate>Allow requests</dt>
          <dd>
            @if (record.metadata.allow_requests) {
              <i id="cipo-allow-request" class="fa fa-check  text-success" aria-hidden="true"></i>
            } @else {
              <i id="cipo-allow-request" class="fa fa-times text-danger" aria-hidden="true"></i>
            }
          </dd>
        </dl>
    </p-fieldset>
    </section>

    <!-- REMINDERS -->
    @if (reminders.length > 0) {
      <section class="mt-3">
        <p-fieldset [legend]="'Reminders'|translate">
          <p-table [value]="record.metadata.reminders">
            <ng-template pTemplate="header">
              <tr>
                <th translate>Type</th>
                <th translate>Days Delay</th>
                <th translate>Communication channel</th>
                <th translate>Amount</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-reminder>
              <tr>
                <td>{{ reminder.type | translate }}</td>
                <td>
                  <i class="fa" [ngClass]="{
                    'fa-calendar-minus-o': reminder.type === 'due_soon',
                    'fa-calendar-plus-o': reminder.type === 'overdue'
                  }"></i>
                  {{ reminder.days_delay }}
                </td>
                <td>{{ reminder.communication_channel | translate }}</td>
                <td>
                  @if (reminder.fee_amount) {
                    {{ reminder.fee_amount | currency: org_currency:true }}
                  } @else {
                    &mdash;
                  }
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-fieldset>
      </section>
    }

    <!-- OVERDUE FEES -->
    @if (overdues?.length > 0) {
      <section class="mt-3">
        <p-fieldset [legend]="'Overdue fees'|translate">
          <p-table [value]="overdues">
            <ng-template pTemplate="header">
              <tr>
                <th translate>Interval of days</th>
                <th translate>Amount/day</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-overdue>
              <tr>
                <td>
                  {{ overdue.from }}
                  <i class="fa fa-long-arrow-right px-2"></i>
                  @if (overdue.to) {
                    {{ overdue.to }}
                  } @else {
                    <span class="text-color-secondary">&infin;</span>
                  }
                </td>
                <td>
                  {{ overdue.fee_amount | currency: org_currency:true }} / {{ 'day' | translate }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </p-fieldset>
        </section>
    }

    <!-- APPLICATION -->
    @if (record.metadata.settings) {
      <section class="mt-3">
        <p-fieldset [legend]="'Application'|translate">
          <p-table styleClass="p-datatable-striped" [value]="settings | keyvalue">
            <ng-template pTemplate="header">
              <tr>
                <th rowspan="2" class="vertical-align-bottom pl-0" translate>Patron types</th>
                <th [attr.colspan]="itemTypes.size" class="text-center" translate>Item types</th>
              </tr>
              <tr>
                @for (itemType of itemTypes; track itemType) {
                  <th class="text-center">
                    <span id="itty-{{itemType}}">{{ itemType | getRecord: 'item_types' : 'field' : 'name' | async }}</span>
                  </th>
                }
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-setting>
              <tr>
                <th id="ptty-{{setting.key}}" class="text-left">
                  {{ setting.key | getRecord: 'patron_types' : 'field' : 'name' | async }}
                </th>
                @for (itemType of itemTypes; track itemType) {
                  <td class="text-center">
                    @for (currentItemType of setting.value; track currentItemType) {
                      @if (itemType === currentItemType) {
                        <i id="ptty-{{setting.key}}-itty-{{currentItemType}}" class="fa fa-check  text-success" aria-hidden="true"></i>
                      }
                    }
                  </td>
                }
              </tr>
            </ng-template>
          </p-table>
        </p-fieldset>
      </section>
    }
  </article>
}
