<!--
  RERO ILS UI
  Copyright (C) 2019-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

@if (patron) {
  <div class="py-2">
  <!-- BLOCKED OR NOT? -->
  @if (patron.patron && patron.patron.blocked) {
    <p-messages
      [value]="[{ severity: 'error', summary: 'This patron is currently blocked' | translate, detail:  patron.patron.blocked_note}]"
      [closable]="false"
      [enableService]="false"
      showTransitionOptions="0ms"
    />
  }

  <section id="contact-profile" class="flex flex-column gap-2">
    <!-- MAIN PROFILE SECTION ================================================== -->
    <div class="border-round border-1 surface-border flex gap-4 p-4">
        <div class="surface-500 border-circle w-10rem h-10rem flex align-items-center justify-content-center">
          <i class="fa fa-user-o fa-4x text-white"></i>
        </div>
      <div class="flex-grow-1">
        <h1>
          {{ patron.last_name }} {{ patron.first_name }}
          @if (patron.patron) {
            <a
              [permissions]="permissions.CIRC_ADMIN"
              [routerLink]="['/circulation', 'patron', patron.patron.barcode[0]]"
              class="p-button p-button-outlined"
            >
              <i class="fa fa-exchange"></i>&nbsp;
              {{ 'Circulation' | translate }}
            </a>
          }
        </h1>
        <dl class="metadata">
          <dt>
            <i class="fa fa-calendar-o"></i>&nbsp;
            {{ 'Date of birth' | translate}}
          </dt>
          <dd>{{ patron.birth_date | dateTranslate:'mediumDate' }}</dd>
          @if (patron.email) {
              <dt>
                <i class="fa fa-envelope"></i>&nbsp;
                {{ 'Email' | translate }}
              </dt>
              <dd>{{ patron.email }}</dd>
          }
          @if (phones; as patronPhones) {
            @if (patronPhones.length > 0) {
              <dt>
                <i class="fa fa-phone"></i>&nbsp;
                {{ patronPhones.length | i18nPlural: {'=1': 'Phone' | translate, 'other': 'Phones' | translate} }}
              </dt>
              <dd>
                <ul class="list-none m-0 p-0">
                  @for (phone of patronPhones; track phone) {
                    <li>
                      {{ phone.value }} <span class="font-bold text-color-secondary lowercase" >({{ phone.type | translate }})</span>
                    </li>
                  }
                </ul>
              </dd>
            }
          }
          @if (patron.street || patron.postal_code || patron.city || patron.country) {
            <dt>
              <i class="fa fa-home"></i>&nbsp;
              {{ 'Address' | translate }}
            </dt>
            <dd>
              @if (patron.street) {
                {{ patron.street }}<br/>
              }
              @if (patron.postal_code || patron.city) {
                {{ patron.postal_code }} {{ patron.city }}<br/>
              }
              @if (patron.country) {
                {{ 'country_' + patron.country | translate }}
              }
            </dd>
          }
        </dl>
      </div>
    </div>

    <div class="border-round border-1 surface-border flex gap-4 p-4">
    <p-accordion class="flex-grow-1" [activeIndex]="[0, 1]" [multiple]="true">
      <!-- NOTES ================================================================= -->
      @if (patron.notes && patron.notes.length > 0) {
      <p-accordionTab>
        <ng-template pTemplate="header">
          <h5>
            {{ patron.notes.length | i18nPlural: {'=1': 'Note', 'other': 'Notes'} | translate }}
          </h5>
        </ng-template>
          @for (note of patron.notes; track note) {
            <dl class="metadata">
              <dt translate>
                {{ note.type }}
              </dt>
              <dd [innerHTML]="note.content | nl2br"></dd>
            </dl>
          }
        </p-accordionTab>
        }
        <!-- USER INFORMATION'S SECTION ============================================= -->
        <p-accordionTab>
          <ng-template pTemplate="header">
            <h4 translate>User informations</h4>
          </ng-template>

          <dl class="metadata">
            <dt>
              <i class="fa fa-user"></i>&nbsp;
              {{ 'Username' | translate }}
            </dt>
            <dd>{{ patron.username }}</dd>
            <dt>
              <i class="fa fa-history"></i>&nbsp;
              {{ 'Keep history' }}
            </dt>
            <dd>
              <i class="fa" [ngClass]="patron.keep_history ? 'fa-check text-success' : 'fa-times text-error'"></i>
            </dd>
            <dt translate>{{ patron.roles | i18nPlural: {'=1': 'Role', 'other': 'Roles'} }}</dt>
            <dd class="flex gap-2 flex-wrap">
              @for (role of patron.roles; track role) {
                <p-tag [severity]="getroleTagSeverity(role)">
                  {{ role | translate }}
                </p-tag>
              }
            </dd>
            <dt translate>Creation date</dt>
            <dd>{{ record.created | dateTranslate: 'mediumDate' }}</dd>
          </dl>
          </p-accordionTab>

    <!-- PATRON INFORMATION'S SECTION =========================================== -->
    @if (patron.patron) {
    <p-accordionTab>
      <ng-template pTemplate="header">
        <h4 translate>Patron information</h4>
      </ng-template>
      <dl class="metadata">
        <dt>
          <i class="fa fa-barcode"></i>&nbsp;
          {{ 'Barcode' | translate }}
        </dt>
        <dd>
          <a [routerLink]="['/circulation', 'patron', patron.patron.barcode[0]]" [linkPermissions]="permissions.CIRC_ADMIN">{{ patron.patron.barcode | join: ', ' }}</a>
        </dd>
        <dt translate>Type</dt>
        <dd>
          {{ patron.patron.type.pid | getRecord: 'patron_types' : 'field' : 'name' | async }}
        </dd>
        <dt translate>Account expiration</dt>
        <dd>
          {{ patron.patron.expiration_date | dateTranslate:'mediumDate' }}
        </dd>
        @if (patron.patron.libraries && patron.patron.libraries.length > 0) {
          <dt>
            <i class="fa fa-university"></i>&nbsp;
            {{ 'Affiliation libraries' | translate }}
          </dt>
          <ul class="list-none m-0 p-0">
            @for (library of patron.patron.libraries; track library) {
              <li>
                {{ library.pid | getRecord: 'libraries' : 'field' : 'name' | async }}
              </li>
            }
          </ul>
        }
        @if (patron.source) {
          <dt translate>Source</dt>
          <dd>{{ patron.source }}</dd>
        }
        @if (patron.local_codes) {
          <dt translate>Local code</dt>
          <dd>{{ patron.local_codes | join: ',' }}</dd>
        }
        @if (patron.second_address) {
          <dt>
            <i class="fa fa-home"></i>&nbsp;
            {{ 'Second address' | translate }}
          </dt>
          <dd>
            @if (patron.second_address.street) {
              {{ patron.second_address.street }}<br/>
            }
            @if (patron.second_address.postal_code || patron.second_address.city) {
              {{ patron.second_address.postal_code }} {{ patron.second_address.city }}<br/>
            }
            @if (patron.second_address.country) {
              {{ 'country_' + patron.second_address.country | translate }}
            }
          </dd>
        }
      </dl>
    </p-accordionTab>
  }
    <!-- LIBRARIAN INFORMATION'S SECTION ======================================== -->

    @if (patron.libraries?.length > 0) {
      <p-accordionTab>
        <ng-template pTemplate="header">
          <h4 translate>Librarian information</h4>
        </ng-template>
        <dl class="metadata">
          <dt>
            <i class="fa fa-university"></i>&nbsp;
            {{ patron.libraries.length | i18nPlural: {'=1': 'Library' | translate, 'other': 'Libraries' | translate} }}
          </dt>
          <dd>
          <ul class="list-none p-0 m-0">
            @for (library of patron.libraries; track library) {
              <li>
                {{ library.pid | getRecord: 'libraries' : 'field' : 'name' | async }}
              </li>
            }
          </ul>
        </dd>
        </dl>
      </p-accordionTab>
    }

    <!-- PERMISSIONS ======================================== -->
    @if (canAccessDisplayPermissions) {
      <p-accordionTab>
        <ng-template pTemplate="header">
          <h4 translate>Permissions</h4>
        </ng-template>
        <admin-patron-permissions [hidden]="false" [pid]="patron.pid"></admin-patron-permissions>
      </p-accordionTab>
    }
    </p-accordion>
    </div>
  </section>
  </div>
}
