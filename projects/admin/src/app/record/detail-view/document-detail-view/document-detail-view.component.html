<!--
  RERO ILS UI
  Copyright (C) 2019-2023 RERO
  Copyright (C) 2019-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<!-- import button for external source importation such as BNF -->
<div *ngIf="record && record.metadata && !record.metadata.pid && pid && source" class="float-right ml-4 mt-2 mb-4" [permissions]="permissions.DOC_CREATE">
  <a (click)="importDocument($event, record, { source: source, pid: pid })"
    class="btn btn-sm btn-outline-primary"
    translate>Import</a>
</div>
<!-- duplicate button -->
<div *ngIf="record && record.metadata && record.metadata.pid" class="float-right mt-2 mb-4 mr-n4 btn-duplicate" [permissions]="permissions.DOC_CREATE">
  <a [routerLink]="['/records', 'documents', 'duplicate']"
    [queryParams]="{type: 'documents', pid: record.metadata.pid}"
    class="btn btn-sm btn-outline-primary"
    translate>Duplicate</a>
</div>
<div class="clearfix"></div>
<ng-container *ngIf="record">
  <!-- HEADER -->
  <header class="row mt-5 mb-3">
    <div class="col-lg-2 d-sm-block text-center">
      <shared-thumbnail [record]="record"></shared-thumbnail>
    </div>
    <div class="col-lg-10">
      <!-- ADMIN METADATA -->
      <ng-container *ngIf="record.metadata.adminMetadata && (record.metadata.adminMetadata.encodingLevel !== 'Full level' || record.metadata.adminMetadata.note)">
        <div class="p-2 alert alert-warning mb-2">
          {{ 'Encoding level' | translate }}: {{ record.metadata.adminMetadata.encodingLevel | translate }}.
          <ng-container *ngIf="record.metadata.adminMetadata.note">
            {{ record.metadata.adminMetadata.note| join: '. ' }}.
          </ng-container>
        </div>
      </ng-container>

      <!-- TITLE -->
      <h2 id="doc-title" *ngIf="record.metadata.title && record.metadata.title | mainTitle as title" class="pl-0 mt-1">
        <ng-core-text-read-more
          [text]="title"
          [unit]="'character'"
          [limit]="150"
          [showMoreLabel]="'Show more' | translate"
          [showLessLabel]="'Show less' | translate"
        ></ng-core-text-read-more>
      </h2>

      <!-- TITLE ALTERNATIVE GRAPHICS -->
      <ng-container *ngIf="record.metadata.ui_title_altgr">
        <ng-container *ngFor="let altgr_title of record.metadata.ui_title_altgr; let i = index">
          <h3 id="{{ 'doc-altgr-title-' + i }}">{{ altgr_title }}</h3>
        </ng-container>
      </ng-container>

      <!-- CONTRIBUTION -->
      <shared-contribution [contributions]="record.metadata?.contribution"
                           [withRoles]="true"
                           [activateLink]="activateLink"
                           [withEntityLink]="true">
      </shared-contribution>

      <!-- PUBLICATION ACTIVITY: PUBLICATION -->
      <ng-container *ngVar="record.metadata.provisionActivity | documentProvisionActivity | keyvalue | callbackArrayFilter: filterPublicationProvisionActivity as provisionActivity">
        <ng-container *ngFor="let provision of provisionActivity">
          <ul class="list-unstyled mb-0">
            <li *ngFor="let value of provision.value">{{ value }}</li>
          </ul>
        </ng-container>
      </ng-container>

      <!-- EXTENT-->
      <div id="doc-extent" *ngIf="record.metadata.extent">
        {{ record.metadata.extent }}
      </div>

      <!-- DURATION -->
      <div id="doc-duration" *ngIf="record.metadata.duration && record.metadata.duration.length > 0">
        {{ 'Duration' | translate }}: {{ record.metadata.duration.join(", ") }}
      </div>

      <!-- EDITION STATEMENT -->
      <div id="doc-edition-statement" *ngIf="record.metadata.editionStatement">
        <ul class="list-unstyled mb-0">
          <li *ngFor="let edition of record.metadata.editionStatement">{{ edition._text[0].value }}</li>
        </ul>
      </div>

      <!-- FREQUENCY -->
      <div id="doc-frequency" *ngIf="record.metadata.frequency">
        <b>{{ 'Frequency' | translate }}</b>:
        <ng-container *ngFor="let freq of record.metadata.frequency; last as isLast">
        {{ freq.label }} <ng-container *ngIf="freq.date">({{ freq.date }})</ng-container><ng-container *ngIf="!isLast">; </ng-container>
        </ng-container>
      </div>

      <!-- IS PART OF -->
      <shared-part-of [record]="record"></shared-part-of>

      <!-- ISSUED WITH -->
      <admin-other-edition
        *ngIf="record.metadata.issuedWith"
        fieldLabel="{{ 'Issued with' | translate }}"
        [field]="record.metadata.issuedWith"
        [header]="true"></admin-other-edition>

      <!-- PRECEDED BY -->
      <admin-other-edition
        *ngIf="record.metadata.precededBy"
        fieldLabel="{{ 'Preceded by' | translate }}"
        [field]="record.metadata.precededBy"
        [header]="true"></admin-other-edition>

      <!-- SUCCEEDED BY -->
      <admin-other-edition
        *ngIf="record.metadata.succeededBy"
        fieldLabel="{{ 'Succeeded by' | translate }}"
        [field]="record.metadata.succeededBy"
        [header]="true"></admin-other-edition>

      <!-- SUPPLEMENT TO -->
      <admin-other-edition
        *ngIf="record.metadata.supplementTo"
        fieldLabel="{{ 'Supplement to' | translate }}"
        [field]="record.metadata.supplementTo"
        [header]="true"></admin-other-edition>

      <!-- REPRODUCTION OF -->
      <admin-other-edition
        *ngIf="record.metadata.reproductionOf"
        fieldLabel="{{ 'Reproduction of' | translate }}"
        [field]="record.metadata.reproductionOf"
        [header]="true"></admin-other-edition>

      <!-- ELECTRONIC LOCATOR: RELATED RESOURCE -->
      <div class="row" *ngIf="relatedResources.length > 0">
        <div class="col">
          <ul class="list-unstyled mt-1 mb-0">
            <li *ngFor="let eloc of relatedResources">
              <admin-related-resource [electronicLocator]="eloc"></admin-related-resource>
            </li>
          </ul>
        </div>
      </div>

      <!-- SUMMARY -->
      <ng-container *ngIf="record.metadata.summary">
        <ng-container *ngFor="let sum of record.metadata.summary">
          <div *ngFor="let data of sum.label">
            <!--
            <span *ngIf="data.language" class="badge badge-secondary mr-1">
              {{ ('lang_script_' + data.language) | translate }}
            </span>
            -->
            <ng-core-text-read-more
              [text]="data.value"
              [unit]="'character'"
              [limit]="400"
              [showMoreLabel]="'Show more' | translate"
              [showLessLabel]="'Show less' | translate"
            ></ng-core-text-read-more>
          </div>
        </ng-container>
      </ng-container>

      <!-- SUBJECTS -->
      <div class="row" *ngIf="record.metadata.subjects as subjects">
        <div class="col">
          <span *ngFor="let subject of subjects"
            class="badge badge-secondary mr-1"
            title="{{ subject.entity.type | translate }}">
            <ng-container [ngTemplateOutlet]="entityLink" [ngTemplateOutletContext]="{ entity: subject, class: 'text-light' }"></ng-container>
          </span>
        </div>
      </div>

      <!-- GENRE, FORM -->
      <div class="mt-1" *ngIf="record.metadata.genreForm">
        <span class="mr-1" *ngFor="let genre of record.metadata.genreForm">
          <ng-container [ngTemplateOutlet]="entityLink" [ngTemplateOutletContext]="{ entity: genre, class: 'text-secondary' }"></ng-container>
        </span>
      </div>

      <!-- MASKED -->
      <admin-record-masked *ngIf="record.metadata._masked" [record]="record" [withLabel]="true"></admin-record-masked>

      <!-- LINKED DOCUMENTS -->
      <a
        class="btn btn-sm btn-outline-primary mt-3"
        [routerLink]="['/records', 'documents']"
        [queryParams]="{q: 'partOf.document.pid:' + pid, simple: 0}"
        *ngIf="linkedDocumentsCount"
      >
        <i class="fa fa-list" aria-hidden="true"></i>
        {{ linkedDocumentsCount }}
        {{ linkedDocumentsCount | i18nPlural: {'=1': 'article/volume', 'other': 'articles/volumes'} | translate }}
      </a>
    </div>
  </header>

  <!-- END OF HEADER -->
  <!-- TABS -->
  <div class="mt-2">
    <tabset>
      <!-- GET TAB -->
      <tab id="documents-get-tab" tabOrder="1" [active]="true" *ngIf="record.metadata.pid">
        <ng-template tabHeading>
          <i class="fa fa-list-ul mr-1"></i>{{ 'Get' | translate }}
        </ng-template>
        <div class="mt-2">
          <!-- HOLDINGS -->
          <admin-holding-organisation [document]="record"></admin-holding-organisation>
        </div>
      </tab>
      <!-- END OF GET TAB -->
      <!-- DESCRIPTION TAB -->
      <tab id="documents-description-tab" tabOrder="2" [active]="!record.metadata.pid">
        <ng-template tabHeading>
          <i class="fa fa-bars mr-1"></i> {{ 'Description' | translate }}
        </ng-template>
        <div class="mt-2">
          <admin-document-description [record]="record"></admin-document-description>
        </div>
      </tab>
      <!-- END OF DESCRIPTION TAB -->
      <!-- LOCAL FIELDS TAB -->
      <tab
        *ngIf="!record.metadata.harvested && record.metadata.pid && showhideLocalFieldsTab"
        id="documents-local-field-tab"
        tabOrder="4"
      >
        <ng-template tabHeading>
          <i class="fa fa-list-ul mr-1"></i> {{ 'Local fields' | translate }}
        </ng-template>
        <div class="mt-2">
          <admin-local-field [resourceType]="'documents'" [resourcePid]="record.metadata.pid"></admin-local-field>
        </div>
      </tab>
      <!-- END OF LOCAL FIELDS TAB -->
      <!-- MARC TAB -->
      <tab id="documents-marc-tab" tabOrder="5" *ngIf="marc$ | async as marc">
        <ng-template tabHeading>
          <i class="fa fa-list-ul mr-1"></i><span translate>Marc</span>
        </ng-template>
        <div class="mt-2">
          <!-- MARC -->
          <table class="table table-striped table-sm">
            <tbody>
            <tr *ngFor="let field of marc">
              <ng-container *ngIf="field | marc as f">
                <th scope="row">{{ f.field }}</th>
                <td>{{ f.ind1 }}</td>
                <td>{{ f.ind2 }}</td>
                <td>{{ f.value }}</td>
              </ng-container>
            </tr>
            </tbody>
          </table>
        </div>
      </tab>
      <!-- END OF MARC TAB -->
    </tabset>
  </div>
  <!-- END OF TABS -->
  <admin-operation-logs-dialog
    *ngIf="isEnabledOperationLog && record.metadata.pid"
    resourceType="documents"
    [resourcePid]="record.metadata.pid"
  ></admin-operation-logs-dialog>
</ng-container>

<ng-template #entityLink let-entity="entity" let-class="class">
  <i class="fa fa-tag mr-1"></i>
  <a
    *ngIf="activateLink && entity.entity.resource_type; else subjectNoLink"
    [class]="class"
    [routerLink]="['/records', entity.entity.resource_type + '_entities', 'detail', entity.entity.pid]"
  >
    {{ entity.entity | entityLabel }}
  </a>
  <ng-template #subjectNoLink>
    {{ entity.entity | entityLabel }}
  </ng-template>
</ng-template>
