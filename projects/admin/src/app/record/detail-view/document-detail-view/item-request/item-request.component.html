<!--
  RERO ILS UI
  Copyright (C) 2020-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@defer(when formFields) {
  <div class="flex gap-2 flex-column">
  @if (requestedBy$ | async; as requestedBy) {
    @if (requestedBy.length > 0) {
      <div class="flex gap-2 align-items-center">
        <p-messages
          class="flex-grow-1"
          [value]="[
            {
              severity: 'warn',
              detail: requestedBy.length < 2
                ? requestedBy.length + ' ' + ('request in the queue' | translate)
                : requestedBy.length + ' ' + ('requests in the queue' | translate)
            }
          ]"
          [closable]="false"
          [enableService]="false"
          showTransitionOptions="0ms"
        />
        <p-button
          outlined
          [routerLink]="['/records', 'items', 'detail', recordPid]"
          (click)="closeModal()"
          [label]="'Edit queue' | translate"
        />
      </div>
    }
  }
  @if (patron) {
    <p-card [header]="[patron.last_name, patron.first_name].join(', ')">
      <p class="m-0">
        {{ patron.street }}<br>
        {{ patron.postal_code }} {{ patron.city }}<br>
        {{ patron.email }}
      </p>
      @if (patron | patronBlockedMessage; as message) {
        <p-messages
          [value]="[{ severity: 'danger', detail: message}]"
          [closable]="false"
          [enableService]="false"
          showTransitionOptions="0ms"
        />
      }
    </p-card>
  }
  <form [formGroup]="form" (ngSubmit)="submit(model)">
    <div class="flex gap-2 flex-column">
      <formly-form [form]="form" [fields]="formFields" [model]="model" />
      <div class="flex justify-content-end">
        <p-button
          id="new-request-button"
          type="submit"
          size="small"
          [disabled]="!form.valid || requestInProgress"
        >
          @if (!requestInProgress) {
            {{ 'New request' | translate }}
          } @else {
            <i class="fa fa-spinner fa-spin"></i>&nbsp;
            {{ 'Request in progress' | translate }}
          }
        </p-button>
      </div>
    </div>
  </form>
</div>
} @placeholder {
  <i class="fa fa-spin fa-spinner"></i>&nbsp;{{ 'loading in progress...' | translate }}
}
