<!--
  RERO ILS UI
  Copyright (C) 2020-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<ngx-spinner
  name="file-upload"
  color="#fff"
  size="medium"
  type="ball-zig-zag"
  [fullScreen]="true"
>
  <p class="text-white">
    {{ "Loading..." | translate }}
    @if (fileUpload?.files?.length > 0) { ({{ nUploadedFiles }} /
    {{ fileUpload.files.length }}) }
  </p>
</ngx-spinner>

@if (files != null) {
<div class="flex flex-col gap-2 py-2">
  <admin-files-collections />
  <div>
    <h5 translate>Upload Files</h5>
    <p-fileUpload
      [disabled]="reachMaxFileLimit"
      #fileUpload
      [auto]="true"
      [multiple]="true"
      name="uploadFiles"
      [chooseLabel]="'Add file' | translate"
      [customUpload]="true"
      (uploadHandler)="uploadHandler($event, '')"
      mode="advanced"
      [maxFileSize]="500 * 1024 * 1024"
      (onSelect)="onSelect($event, '')"
    >
      <ng-template #toolbar>
        <div class="mt-2">
          <p class="text-warning" translate>
            By uploading a file, I declare that I am aware of the terms and
            conditions of the copyright transfer agreement governing the
            publication of the respective document, and that the deposit of its
            full-text content in the current platform is compatible with those.
          </p>
        </div>
      </ng-template>
      <ng-template #file let-file></ng-template>
      <ng-template #content let-file>
        @if (reachMaxFileLimit) {
          <p-message
            [text]="'The maximum number of files is reached. No additional upload is allowed.' | translate"
            severity="error"
            showTransitionOptions="0ms"
          />
        } @else {
        <span translate>Drag and drop files.</span>
        }
      </ng-template>
    </p-fileUpload>
  </div>

  @if (files.length > 0) {
  <div>
    <h5 translate>Uploaded Files</h5>
    <p-inputGroup>
      <input
        id="filter"
        type="text"
        pInputText
        [placeholder]="'filter' | translate"
        [(ngModel)]="filterText"
        (keyup)="onTextChange($event)"
      />
      <p-inputGroupAddon>
        <i class="fa fa-filter"></i>
      </p-inputGroupAddon>
    </p-inputGroup>

    <small *ngVar="filteredFiles.length as total" id="filtered-results">
      {{ getResultsText() | async }}
    </small>
  </div>

  @if(filteredFiles.length > 0) {
  <ul class="list-none alternate-color border border-surface rounded-border p-2 m-0">
    @for (file of filteredFiles;track file.label) {
    <li>
      <div class="grid grid-cols-12 gap-4 items-center">
        <div class="col-span-6">
          <a
            class="text-link"
            tabindex="-1"
            [pTooltip]="
              (file.size | filesize) +
              ' / ' +
              (file.updated | dateTranslate : 'medium')
            "
            tooltipPosition="top"
            title="download"
            [href]="toRelative(file.links.content)"
            download
            >{{ file.key }} <i class="fa fa-download"></i
          ></a>
        </div>
        <div class="col-span-5">
          <div class="input-group">
            <p-inputGroup>
              <input
                pInputText
                #inputLabel
                [value]="file.label"
                type="text"
                class="form-control"
                [placeholder]="'label' | translate"
                aria-label="label"
                (keyup.enter)="updateLabel(file, inputLabel.value)"
              />
              <button
                pButton
                [disabled]="
                  inputLabel.value.length === 0 ||
                  inputLabel.value.trim() === file.label
                "
                (onClick)="updateLabel(file, inputLabel.value)"
                outlined
                type="button"
                icon="fa fa-save"
              ></button>
            </p-inputGroup>
          </div>
        </div>
        <div class="col-span-1 flex justify-end">
          <p-button
            outlined
            tabindex="-1"
            severity="danger"
            (onClick)="deleteFile(file)"
            title="{{ 'remove' | translate }}"
            icon="fa fa-trash"
          />
        </div>
      </div>
    </li>
    }
  </ul>
  } }
</div>
} @else {
<i class="fa fa-spinner fa-spin"></i>
}
