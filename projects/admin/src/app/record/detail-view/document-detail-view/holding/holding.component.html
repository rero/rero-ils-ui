<!--
  RERO ILS UI
  Copyright (C) 2019-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<p-accordionTab>
  <ng-template pTemplate="header">
    <!-- MAIN ROW ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
    <div class="w-full">
      <div class="grid align-items-center">
        <div id="holding-location-{{ holding.metadata.pid }}" class="col-6">
          @if (holding.metadata._masked) {
            <admin-record-masked [record]="holding"></admin-record-masked>
          }
          <span>{{ holding.metadata.library.name }}: {{ holding.metadata.location.name }}</span>
        </div>

        <div class="col-2">
          {{ holding.metadata.circulation_category.circulation_information | getTranslatedLabel : language }}
        </div>

        @if (holdingType === 'serial') {
          <div class="col-4 justify-content-end flex">
            @if (permissions) {
              <div class="flex gap-1 mr-3">
                <!-- HOLDING VIEW -->
                <p-button
                  icon="fa fa-eye"
                  [title]="'Holdings detail'|translate"
                  size="small"
                  outlined
                  [routerLink]="['/', 'records', 'holdings', 'detail', holding.metadata.pid]"
                />
                <!-- REQUEST BUTTON -->
                <p-button
                  icon="fa fa-shopping-basket"
                  [title]="'Holdings request'|translate"
                  outlined
                  size="small"
                  (onClick)="addRequest(holding.metadata.pid, 'holding')"
                  class="pointer-events-auto"
                  [pTooltip]="cannotRequestTooltipContent"
                  tooltipPosition="top"
                  [disabled]="!permissions.canRequest?.can"
                  [tooltipDisabled]="permissions.canRequest?.can"
                />
                <ng-template #cannotRequestTooltipContent>
                  <span [innerHTML]="cannotRequestInfoMessage | nl2br"></span>
                </ng-template>
                <!-- EDIT BUTTON -->
                @if (permissions && permissions.update && permissions.update.can) {
                  <p-button
                    icon="fa fa-pencil"
                    outlined
                    size="small"
                    [title]="'Edit holdings'|translate"
                    [routerLink]="['/', 'records', 'holdings', 'edit', holding.metadata.pid]"
                  />
                }
                <!-- DELETE BUTTON -->
                <p-button
                  icon="fa fa-trash"
                  class="pointer-events-auto"
                  severity="danger"
                  outlined
                  size="small"
                  [title]="'Delete holdings'|translate"
                  (onClick)="delete()"
                  [pTooltip]="tooltipContent"
                  tooltipPosition="top"
                  [disabled]="!permissions.delete?.can"
                  [tooltipDisabled]="permissions.delete?.can"
                />
                <ng-template #tooltipContent>
                  <span [innerHTML]="deleteInfoMessage | nl2br"></span>
                </ng-template>
              </div>
            }
          </div>
          <admin-holding-detail context="document" [holding]="holding" class="col-12"></admin-holding-detail>
        }
    </div>
  </div>
  </ng-template>
      @switch (holdingType) {
        <!-- ELECTRONIC HOLDING -->
        @case ('electronic') {
          <div class="row">
            @for (elocation of holding.metadata.electronic_location; track elocation) {
              <div class="col">
                <a class="rero-ils-external-link" [href]="elocation.uri | safeUrl">{{ elocation.source }}</a>
              </div>
            }
          </div>
        }
        <!-- SERIAL HOLDING -->
        @case ('serial') {
          @if (items) {
            <div class="grid grid-nogutter py-2 px-1 font-bold">
              <div class="col-3" translate>Barcode</div>
              <div class="col-3" translate>Status</div>
              <div class="col-3" translate>Unit</div>
              <div class="col-3" translate>Call number</div>
            </div>
            <div class="alternate-color">
            @for (item of items | slice:0: displayItemsCounter; track item) {
              <admin-serial-holding-item
                [holding]="holding"
                [item]="item"
                [isCurrentOrganisation]="isCurrentOrganisation"
                (deleteItem)="deleteItem($event)"
                [attr.id]="$any(item).metadata.barcode | idAttribute:{prefix: 'item'}"
              />
            }
            </div>
            @if (displayItemsCounter < totalItemsCounter) {
              <div class="grid">
                <p-button [link]="true" (onClick)="showMore(5)" [attr.id]="holding.metadata.pid | idAttribute:{prefix: 'holding', suffix: 'show-more-button'}">
                  <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i>
                  {{ 'Show more' | translate }} ...
                </p-button>
                <small class="pl-2 pt-1 text-secondary">({{ showMoreItemsCounter('issue') }})</small>
              </div>
            }
          } @else {
            <div class="grid">
              <div class="offset-1 col-11" translate>No item received.</div>
            </div>
          }
        }
        @default {
          <!-- DEFAULT HOLDING ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          @if (items && items.length > 0) {
            @for (item of items | slice:0: displayItemsCounter; track item; let last = $last) {
                <admin-default-holding-item
                    [holding]="holding"
                    [item]="item"
                    [isCurrentOrganisation]="isCurrentOrganisation"
                    (deleteItem)="deleteItem($event)"
                    [attr.id]="$any(item).metadata.barcode | idAttribute:{prefix: 'item'}">
                </admin-default-holding-item>
            }
            @if (displayItemsCounter < totalItemsCounter) {
              <div class="row pl-3">
                <a [routerLink]="[]" (click)="showMore(5)" [attr.id]="holding.metadata.pid | idAttribute:{prefix: 'holding', suffix: 'show-more-button'}">
                  <i class="fa fa-arrow-circle-o-down" aria-hidden="true"></i>
                  {{ 'Show more' | translate }} ...
                </a>
                <span class="pl-2 pt-1 small text-secondary">({{ showMoreItemsCounter('item') }})</span>
              </div>
            }
          }
        }
      }
</p-accordionTab>

