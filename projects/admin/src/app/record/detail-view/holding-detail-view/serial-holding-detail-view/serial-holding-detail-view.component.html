<!--
  RERO ILS UI
  Copyright (C) 2019-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1 class="mb-2" translate>Holdings</h1>
@if (holding.metadata._masked) {
  <admin-record-masked [record]="holding" [withLabel]="true"></admin-record-masked>
}
@if (holding.metadata.document.pid | getRecord:'documents' | async; as document) {
  <div class="card mb-3">
    <div class="card-body row">
      <a [routerLink]="['/records', 'documents', 'detail', $any(document).metadata.pid]" class="col-1">
        <i class="fa fa-arrow-left"></i>
      </a>
      <admin-documents-brief-view
          class="col"
          [record]="document"
          [type]="'documents'" [detailUrl]="{
            link: '/records/documents/detail/' + $any(document).metadata.pid,
            external: false
          }"
      ></admin-documents-brief-view>
    </div>
  </div>
}
@if (holding) {
  <admin-holding-shared-view [holding]="holding" class="row col"></admin-holding-shared-view>
}

<!-- TABS ================================================================= -->
<!--    3 tabs will be displayed : Issues, Holdings details, Local fields -->


<p-tabView styleClass="mt-2">
  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul mr-1"></i>{{ 'Issues' | translate }}
    </ng-template>
      <!-- top actions bar ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <div class="d-flex">
        <p-button
          [outlined]="true"
          [routerLink]="[]"
          (onClick)="showMore('prediction', 3)"
        >
          <i class="fa fa-arrow-circle-o-up mr-1" aria-hidden="true"></i>
          {{ 'Show more' | translate }} &hellip;
        </p-button>
        @if (allowIssueCreation) {
          <button class="ml-auto btn btn-sm btn-outline-primary"
                  [routerLink]="['/records', 'items', 'new']"
                  [queryParams]="{
                    'holding': holding.id,
                    'irregular': true,
                    'redirectTo': 'records/holdings/detail/' + holding.id
                  }"
          >
            <i class="fa fa-plus-square-o"></i>
            {{ 'Add irregular issue' | translate }} &hellip;
          </button>
        }
      </div>
      <div class="issues">
        <!-- expected issues ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        @for (prediction of predictionsItems; track prediction; let last = $last) {
          <admin-expected-issue [issue]="prediction">
            @if (last) {
              <ng-container actions>
                @if (allowIssueCreation) {
                  <p-button
                    icon="fa fa-check-circle"
                    [title]="'Quick receive'|translate"
                    [outlined]="true"
                    (onClick)="quickIssueReceive()"
                  />
                }
                @if (allowIssueCreation) {
                  <p-button
                    icon="fa fa-plus"
                    [title]="'Receive and edit this issue'|translate"
                    [outlined]="true"
                    [routerLink]="['/records', 'items', 'new']"
                    [queryParams]="{
                      'holding': holding.id,
                      'redirectTo': 'records/holdings/detail/' + holding.id,
                      'enumerationAndChronology': prediction.issue,
                      'expected_date': prediction.expected_date
                    }"
                    styleClass="ml-1"
                  />
                }
              </ng-container>
            }
          </admin-expected-issue>
        }
        <!-- received issues ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        @for (item of receivedItems; track item; let last = $last) {
          <admin-received-issue [issue]="item" [holding]="holding" (delete)="deleteIssue($event)"></admin-received-issue>
        }
      </div>
      <!-- SHOW MORE RECEIVED ISSUE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      @if (receivedItems.length < totalReceivedItems) {
        <div class="row mt-1">
          <div class="col">
            <p-button
              [outlined]="true"
              [routerLink]="[]"
              (onClick)="showMore('received', 5)"
            >
              <i class="fa fa-arrow-circle-o-down mr-1" aria-hidden="true"></i>
              {{ 'Show more' | translate }} &hellip;
            </p-button>
            <span class="pl-3 small text-secondary">({{ showMoreIssuesCounter }})</span>
          </div>
        </div>
      }
  </p-tabPanel>

  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul mr-1"></i><span translate>Details</span>
    </ng-template>
    <admin-holding-detail context="holdings" [holding]="holding"></admin-holding-detail>
  </p-tabPanel>

  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul mr-1"></i><span translate>Local fields</span>
    </ng-template>
    <admin-local-field [resourceType]="'holdings'" [resourcePid]="holding.metadata.pid"></admin-local-field>
  </p-tabPanel>

</p-tabView>
