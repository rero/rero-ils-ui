<!--
  RERO ILS UI
  Copyright (C) 2019-2024 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1 translate>Holdings</h1>
@if (holding.metadata._masked) {
  <admin-record-masked [record]="holding" [withLabel]="true"></admin-record-masked>
}
@if (holding.metadata.document.pid | getRecord:'documents' | async; as document) {
    <div class="border-1 border-round surface-border p-4">
      <admin-documents-brief-view
          [record]="document"
          [type]="'documents'" [detailUrl]="{
            link: '/records/documents/detail/' + $any(document).metadata.pid,
            external: false
          }"
      />
    </div>
}
@if (holding) {
  <admin-holding-shared-view [holding]="holding" />
}

<!-- TABS ================================================================= -->
<!--    3 tabs will be displayed : Issues, Holdings details, Local fields -->


<p-tabView>
  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul"></i>&nbsp;{{ 'Issues' | translate }}
    </ng-template>
    <div class="flex flex-column gap-2">
      <!-- top actions bar ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      <div class="flex">
        <p-button
          class="flex-grow-1"
          outlined
          (onClick)="showMore('prediction', 3)"
          icon="fa fa-arrow-circle-o-up"
          size="small"
          label="{{ 'Show more' | translate }} &hellip;"
        />
        @if (allowIssueCreation) {
          <p-button size="small" outlined
              [routerLink]="['/records', 'items', 'new']"
              [queryParams]="{
                'holding': holding.id,
                'irregular': true,
                'redirectTo': 'records/holdings/detail/' + holding.id
              }"
              icon="fa fa-plus-square-o"
              label="{{ 'Add irregular issue' | translate }} &hellip;"
          />
        }
      </div>
      <div class="flex flex-column">
        <!-- expected issues ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        @for (prediction of predictionsItems; track prediction; let last = $last) {
          <admin-expected-issue [issue]="prediction">
            @if (last) {
              <ng-container actions>
                @if (allowIssueCreation) {
                  <p-button
                    icon="fa fa-check-circle"
                    size="small"
                    [title]="'Quick receive'|translate"
                    outlined
                    (onClick)="quickIssueReceive()"
                  />
                }
                @if (allowIssueCreation) {
                  <p-button
                    icon="fa fa-plus"
                    size="small"
                    [title]="'Receive and edit this issue'|translate"
                    outlined
                    [routerLink]="['/records', 'items', 'new']"
                    [queryParams]="{
                      'holding': holding.id,
                      'redirectTo': 'records/holdings/detail/' + holding.id,
                      'enumerationAndChronology': prediction.issue,
                      'expected_date': prediction.expected_date
                    }"
                    styleClass="ml-1"
                  />
                }
              </ng-container>
            }
          </admin-expected-issue>
        }
        <!-- received issues ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
        @for (item of receivedItems; track item; let last = $last) {
          <admin-received-issue [issue]="item" [holding]="holding" (delete)="deleteIssue($event)" />
        }
      </div>
      <!-- SHOW MORE RECEIVED ISSUE ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
      @if (receivedItems.length < totalReceivedItems) {
        <div class="flex align-items-center gap-2">
        <p-button
          outlined
          size="small"
          (onClick)="showMore('received', 5)"
          icon="fa fa-arrow-circle-o-down"
          label="{{ 'Show more' | translate }} &hellip;"
          />
        <small class="text-color-secondary">({{ showMoreIssuesCounter }})</small>
      </div>
      }
    </div>
  </p-tabPanel>

  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul"></i>&nbsp;<span translate>Details</span>
    </ng-template>
    <admin-holding-detail context="holdings" [holding]="holding"></admin-holding-detail>
  </p-tabPanel>

  <p-tabPanel>
    <ng-template pTemplate="header">
      <i class="fa fa-list-ul"></i>&nbsp;<span translate>Local fields</span>
    </ng-template>
    <admin-local-field [resourceType]="'holdings'" [resourcePid]="holding.metadata.pid"></admin-local-field>
  </p-tabPanel>

</p-tabView>
