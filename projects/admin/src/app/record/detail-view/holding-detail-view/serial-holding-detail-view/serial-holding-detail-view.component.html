<!--
  RERO ILS UI
  Copyright (C) 2019-2025 RERO

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<h1 translate>Holdings</h1>
<div class="ui:mb-4">
  @if (holding().metadata._masked) {
    <admin-record-masked [record]="holding()" [withLabel]="true"></admin-record-masked>
  }
  @if (holding().metadata.document.pid | getRecord:'documents' | async; as document) {
      <div class="ui:border ui:rounded-border ui:border-surface ui:p-6">
        <admin-documents-brief-view
            [record]="document"
            [type]="'documents'" [detailUrl]="{
              link: '/records/documents/detail/' + $any(document).metadata.pid,
              external: false
            }"
        />
      </div>
  }
  @if (holding()) {
    <div class="ui:mt-3">
      <admin-holding-shared-view [holding]="holding()" />
    </div>
  }
</div>

<p-tabs value="issue">
  <p-tablist>
    <p-tab value="issue">
      <i class="fa fa-list-ul"></i>&nbsp;{{ 'Issues' | translate }}
    </p-tab>
    <p-tab value="detail">
      <i class="fa fa-list-ul"></i>&nbsp;{{ 'Details' | translate }}
    </p-tab>
    @if (store.isDisplayLocalFieldsTab()) {
      <p-tab value="local">
        <i class="fa fa-list-ul"></i>&nbsp;{{ 'Local fields' | translate }}
      </p-tab>
    }
  </p-tablist>
  <p-tabpanels>
    <p-tabpanel value="issue">
      @if (holding().metadata.patterns) {
        <div class="ui:flex ui:flex-col ui:gap-2">
          <div class="ui:flex">
            <h4 translate>Prediction</h4>
            <div class="ui:flex ui:flex-1 ui:justify-end">
              <p-button
                icon="fa fa-arrow-circle-o-up"
                size="small"
                label="{{ 'Show more' | translate }} &hellip;"
                [outlined]="true"
                (onClick)="store.moreIssues(3)"
              />
            </div>
          </div>

          <div class="ui:flex ui:flex-col">
            @for (prediction of store.issues(); track $index; let last = $last) {
              <admin-expected-issue [issue]="prediction">
                @if (last) {
                  <ng-container actions>
                    @if (store.isAllowIssueCreation()) {
                      <p-button
                        icon="fa fa-check-circle"
                        size="small"
                        [title]="'Quick receive'|translate"
                        [outlined]="true"
                        (onClick)="store.quickIssueReceive()"
                        [disabled]="store.quickReceiveDisableButton()"
                      />
                    }
                  </ng-container>
                }
              </admin-expected-issue>
            }
          </div>
        </div>
      }

      <div class="ui:flex ui:flex-col ui:gap-2" [class]="{ 'ui:mt-6': holding().metadata.patterns}">
        <div class="ui:flex">
          <h4 translate>Issues</h4>
          @if (store.isAllowIssueCreation()) {
            <div class="ui:flex ui:flex-1 ui:justify-end">
              <p-button size="small" outlined
                [routerLink]="['/records', 'items', 'new']"
                [queryParams]="{
                  'holding': holding().metadata.pid,
                  'irregular': true,
                  'redirectTo': 'records/holdings/detail/' + holding().metadata.pid
                }"
                icon="fa fa-plus-square-o"
                label="{{ 'Add irregular issue' | translate }} &hellip;"
              />
            </div>
          }
        </div>

        <div class="ui:flex ui:flex-col">
          @if (store.isFilterEnabled()) {
            <div class="ui:my-2">
              <p-inputgroup>
                <input pInputText [(ngModel)]="filter" [placeholder]="'Filter' | translate" />
                <p-inputgroup-addon><i class="fa fa-filter"></i></p-inputgroup-addon>
              </p-inputgroup>
              @if (store.receivedItemsCount() > 0) {
                <small class="ui:ml-2">
                  @if (store.filterTotal() <= 1) {
                    {{ "{{ total }} result of {{ remoteTotal }}" | translate: { total: store.filterTotal(), remoteTotal: store.receivedItemsCount() } }}
                  } @else {
                    {{ "{{ total }} results of {{ remoteTotal }}" | translate: { total: store.filterTotal(), remoteTotal: store.receivedItemsCount() } }}
                  }
                </small>
              }
            </div>
          }
          @for (item of store.receivedItems(); track item.metadata.pid; let last = $last) {
            <admin-received-issue [issue]="item" [holding]="holding()" />
          }
          @if (store.isPaginatorEnabled()) {
            <shared-paginator class="ui:mt-4" [pager]="store.pager()" [total]="store.receivedItemsCount()" (pageChange)="store.setPaginator($event)" />
          }
        </div>
      </div>
    </p-tabpanel>
    <p-tabpanel value="detail">
      <admin-holding-detail context="holdings" [holding]="holding()"></admin-holding-detail>
    </p-tabpanel>
    @if (store.isDisplayLocalFieldsTab()) {
      <p-tabpanel value="local">
        <admin-local-field [resourceType]="'holdings'" [resourcePid]="holding().metadata.pid"></admin-local-field>
      </p-tabpanel>
    }
  </p-tabpanels>
</p-tabs>
