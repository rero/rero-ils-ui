<!--
  RERO ILS UI
  Copyright (C) 2019-2025 RERO
  Copyright (C) 2019-2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
@if (record) {
  <section id="library-profile" class="flex flex-col gap-2">
    <div class="rounded-border border border-surface flex gap-6 p-6">
      <div class="bg-surface-500 dark:bg-surface-300 rounded-full w-40 h-40 flex items-center justify-center">
        <i class="fa fa-university fa-4x text-white"></i>
      </div>
    <div class="grow">
        <h1>{{ record.name }}</h1>
        <dl class="metadata">
          <dt><i class="fa fa-code"></i>&nbsp;<span translate>Code</span></dt>
          <dd>{{ record.code }}</dd>
          @if (record.email) {
            <dt><i class="fa fa-at"></i>&nbsp;<span translate>Email</span></dt>
            <dd>{{ record.email }}</dd>
          }
          @if (record.address) {
            <dt><i class="fa fa-home"></i>&nbsp;<span translate>Address</span></dt>
            <dd>{{ record.address }}</dd>
          }
          <dt><i class="fa fa-language"></i>&nbsp;<span translate>Language</span></dt>
          <dd>{{ ('lang_' + record.communication_language) | translate | ucfirst }}</dd>
        </dl>
      </div>
    </div>
  </section>

  <p-accordion multiple [value]="[0]">
    <!-- locations ======================================================== -->
    <p-accordion-panel value="0" #locTab>
      <p-accordion-header>
        <div class="flex w-full items-center justify-between mr-2">
          <div>
            <i class="fa fa-map-marker"></i>&nbsp;<span translate>Locations</span>
          </div>
          <p-button
            [hidden]="!(isUserCanAddLocation && locTab.active())"
            icon="fa fa-plus-square-o"
            [label]="'Add'|translate"
            outlined
            [routerLink]="['/', 'records', 'locations', 'new']"
            [queryParams]="{ library: record.pid }"
            styleClass="ml-2 align-items-right"
          />

        </div>
      </p-accordion-header>
      <p-accordion-content>
        @if (locations) {
          <ul class="list-none alternate-color">
            @for (location of locations; track location; let last=$last) {
              <li class="my-2">
                <admin-location [location]="location" [library]="record" (deleteLocation)="deleteLocation($event)" />
              </li>
            }
          </ul>
        } @else {
          <p translate>no location</p>
        }
      </p-accordion-content>
    </p-accordion-panel>
    <!-- opening hours ==================================================== -->
    <p-accordion-panel value="1">
      <p-accordion-header>
        <div class="flex w-full items-center justify-between mr-2">
          <div>
            <i class="fa fa-clock-o"></i>&nbsp;
            <span translate>Opening Hours</span>
          </div>
          <div class="flex gap-1">
            @for (day of record.opening_hours; track day) {
              <i class="fa" [ngClass]="{'fa-times-circle-o text-error': !day.is_open, 'fa-circle text-success': day.is_open}"></i>
            }
          </div>
      </div>
      </p-accordion-header>
      <p-accordion-content>
        <div class="mt-2">
          @for (day of record.opening_hours; track day) {
            <admin-day-opening-hours [day]="day" />
          }
        </div>
      </p-accordion-content>
    </p-accordion-panel>
    <!-- exception dates ================================================== -->
    @if (record.exception_dates) {
      <p-accordion-panel value="2">
        <p-accordion-header>
          <div class="flex w-full items-center justify-between mr-2">
            <div>
            <i class="fa fa-exclamation-triangle"></i>&nbsp;
            <span translate>Exceptions (holidays, etc.)</span>
          </div>
            <p-badge [value]="record.exception_dates.length" />
        </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="alternate-color mt-2">
            @for (exception of record.exception_dates; track exception) {
              <admin-exception-date [exception]="exception" />
            }
          </div>
        </p-accordion-content>
      </p-accordion-panel>
    }
    <!-- notification settings ============================================ -->
    <p-accordion-panel value="3">
      <p-accordion-header>
        <div>
        <i class="fa fa-envelope-o"></i>&nbsp;
        <span translate>Notification settings</span>
      </div>
      </p-accordion-header>
      <p-accordion-content>
        <div class="mt-2">
          @if (record.notification_settings; as notificationSettings) {
            <dl class="metadata">
              @for (setting of notificationSettings; track setting) {
                <dt>{{ setting.type | translate | ucfirst }}</dt>
                <dd>
                  {{ setting.email }}
                  @if (setting.delay) {
                    ; {{ 'Delay' | translate }}: {{ setting.delay }}
                    {{ setting.delay > 1 ? ('minutes' | translate) : ('minute' | translate) }}
                  }
                </dd>
              }
            </dl>
          }
        </div>
      </p-accordion-content>
    </p-accordion-panel>
    <!-- acquisition settings ============================================= -->
    <p-accordion-panel value="4">
      <p-accordion-header>
        <div>
        <i class="fa fa-university mr-2"></i>&nbsp;
        <span translate>Acquisition settings</span>
      </div>
      </p-accordion-header>
      <p-accordion-content>
        <div class="mt-2">
          @if (record.acquisition_settings; as acquisitionSettings) {
            <p-divider align="left">
              <div>
                <i class="fa fa-book"></i>&nbsp;
                <span translate>Default acquisition settings</span>
              </div>
            </p-divider>
            <div class="grid grid-cols-12 gap-4">
              @if (acquisitionSettings.shipping_informations; as acqInfos) {
                <ng-container [ngTemplateOutlet]="address_block"
                              [ngTemplateOutletContext]="{ label: 'Shipping informations' | translate, data: acqInfos, icon: 'fa-truck'}"
                />
              }
              @if (acquisitionSettings.billing_informations; as acqInfos) {
                <ng-container [ngTemplateOutlet]="address_block"
                              [ngTemplateOutletContext]="{ label: 'Billing informations' | translate, data: acqInfos, icon: 'fa-money'}"
                />
              }
            </div>
          }
          @if (record.serial_acquisition_settings; as acquisitionSettings) {
            <p-divider align="left">
              <div>
                <i class="fa fa-newspaper-o"></i>&nbsp;
                <span translate>Serial acquisition settings</span>
              </div>
            </p-divider>
            <div class="grid grid-cols-12 gap-4 justify-start">
              @if (acquisitionSettings.shipping_informations; as acqInfos) {
                <ng-container [ngTemplateOutlet]="address_block"
                              [ngTemplateOutletContext]="{ label: 'Shipping informations' | translate, data: acqInfos, icon: 'fa-truck'}"
                />
              }
              @if (acquisitionSettings.billing_informations; as acqInfos) {
                <ng-container [ngTemplateOutlet]="address_block"
                              [ngTemplateOutletContext]="{ label: 'Billing informations' | translate, data: acqInfos, icon: 'fa-money'}"
                />
              }
            </div>
          }
        </div>
      </p-accordion-content>
    </p-accordion-panel>
    <!-- rollover settings ================================================ -->
    @if (record.rollover_settings) {
      <p-accordion-panel value="5">
        <p-accordion-header>
          <div class="flex w-full items-center justify-between mr-2">
            <div>
              <i class="fa fa-wrench mr-2"></i>&nbsp;
              <span translate>Rollover settings</span>
            </div>
            <i class="fa"
                [ngClass]="{
                  'fa-times text-error': record.rollover_settings.account_transfer === 'rollover_no_transfer',
                  'fa-check text-success': record.rollover_settings.account_transfer === 'rollover_allocated_amount'
                }"
            ></i>
          </div>
        </p-accordion-header>
        <p-accordion-content>
          <div class="mt-2">
            <dl class="metadata">
              <dt translate>Account transfer</dt>
              <dd>{{ record.rollover_settings.account_transfer | translate }}</dd>
            </dl>
          </div>
        </p-accordion-content>
      </p-accordion-panel>
    }
  </p-accordion>

  <ng-template #address_block let-label="label" let-icon="icon" let-data="data">
    <p-fieldset class="col-span-6">
      <ng-template #header>
        <p-tag class="mx-2">
          @if (icon) {
            <i class="fa {{ icon }}"></i>&nbsp;
          }
          {{ label }}
        </p-tag>
      </ng-template>
      <div class="flex gap-2 flex-col">
        <div class="flex gap-2">
          <i class="fa fa-home"></i>
          <div>
            {{ data.name }}<br/>
            @if (data.address) {
              @if (data.address.street) {
                {{ data.address.street }}<br/>
              }
              @if (data.address.zip_code || data.address.city) {
                @if (data.address.zip_code) {
                  {{ data.address.zip_code }}
                }
                @if (data.address.zip_code && data.address.city) {
                  -
                }
                @if (data.address.city) {
                  {{ data.address.city }}
                }
                <br/>
              }
              @if (data.address.country) {
                {{ data.address.country | countryCodeTranslate }}
              }
            }
          </div>
        </div>
        @if (data.email) {
          <div class="flex gap-2 items-center">
            <i class="fa fa-at"></i>
            <span>{{ data.email }}</span>
          </div>
        }
        @if (data.phone) {
          <div class="flex gap-2 items-center">
            <i class="fa fa-phone-square"></i>
            <span>{{ data.phone }}</span>
          </div>
        }
        @if (data.extra) {
          <div class="flex gap-2 items-center">
            <i class="fa fa-sticky-note-o"></i>
            <span>{{ data.extra }}</span>
          </div>
        }
      </div>
    </p-fieldset>
  </ng-template>
}
