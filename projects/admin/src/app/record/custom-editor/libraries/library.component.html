<!--
  RERO ILS UI
   Copyright (C) 2019 RERO

   This program is free software: you can redistribute it and/or modify
   it under the terms of the GNU Affero General Public License as published by
   the Free Software Foundation, version 3 of the License.

   This program is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
   GNU Affero General Public License for more details.

   You should have received a copy of the GNU Affero General Public License
   along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<div class="container">
  <ng-container *ngIf="libForm">
    <h1 translate>Library</h1>
    <form [formGroup]="libForm" (ngSubmit)="onSubmit()">
      <div class="form-group row">
        <label for="name" class="col-2 col-form-label required">
          {{ 'Name' | translate }} <strong class="text-danger">*</strong>
        </label>
        <div class="col-10">
          <input class="form-control" id="name" formControlName="name"
            placeholder="{{ 'Please insert a name' | translate }}" required>
          <div *ngIf="name.invalid && (name.dirty || name.touched)" class="text-danger pt-1">
            <div *ngIf="name.errors.required" translate>
              Name is required.
            </div>
            <div *ngIf="name.errors.minlength" translate>
              Name must be at least 4 characters long.
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="address" class="col-2 col-form-label" translate>Address</label>
        <div class="col-10">
          <input id="address" class="form-control" formControlName="address">
          <div *ngIf="address.invalid && (address.dirty || address.touched)" class="text-danger pt-1">
            <div *ngIf="address.errors.minlength" translate>
              Address must be at least 4 characters long.
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="email" class="col-2 col-form-label" translate>Email</label>
        <div class="col-10">
          <input id="email" class="form-control" formControlName="email">
          <div *ngIf="email.invalid && (email.dirty || email.touched)" class="text-danger pt-1">
            <div *ngIf="email.errors.email" translate>
              Email format is not correct.
            </div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="email" class="col-2 col-form-label required">
          {{ 'Code' | translate }}
          <strong class="text-danger">*</strong>
        </label>
        <div class="col-10">
          <input id="code" class="form-control" formControlName="code" placeholder="{{ 'Please insert a code' | translate }}" required>
          <div *ngIf="code.invalid && (code.dirty || code.touched)" class="text-danger pt-1">
            <div *ngIf="code.errors.alreadyTakenMessage" translate>Code is already taken.</div>
            <div *ngIf="code.pending" translate>Validatingâ€¦</div>
          </div>
        </div>
      </div>
      <div class="form-group row">
        <label for="communication_language" class="col-2 col-form-label">
          {{ 'Communication language' | translate }} <strong class="text-danger">*</strong>
        </label>
        <div class="col-10">
          <select id="communication_language" class="form-control" formControlName="communication_language" required>
            <option value="" disabled translate>Choose a language</option>
            <option [ngValue]="language" *ngFor="let language of availableCommunicationLanguages">
              {{ ('lang_' + language) | translate }}
            </option>
          </select>
          <div *ngIf="communicationLanguage.invalid && (communicationLanguage.dirty || communicationLanguage.touched)" class="text-danger pt-1">
            <div *ngIf="communicationLanguage.errors.required" translate>
              Communication language is required.
            </div>
          </div>
        </div>
      </div>

      <tabset #staticTabs>
        <tab>
          <ng-template tabHeading><i class="fa fa-clock-o mr-2"></i>{{ 'Opening Hours' | translate }}</ng-template>
          <div class="mt-3" formArrayName="opening_hours" *ngFor="let day of openingHours.controls; let i=index">
            <div [formGroupName]="i">
              <div class="form-group row" [ngClass]="{'pt-3': i>0}">
                <div class="col-2">
                  <div class="custom-control custom-switch">
                    <input formControlName="is_open"
                           class="custom-control-input"
                           type="checkbox"
                           [id]="day.value.day"
                           [checked]="day.value.is_open"
                    >
                    <label class="custom-control-label" [for]="day.value.day">
                      {{ day.value.day | translate | titlecase }}
                    </label>
                  </div>
                </div>
                <div class="col-10">
                  <ul class="list-unstyled mb-0">
                    <li formArrayName="times" *ngFor="let time of day.controls.times.controls; let t=index; let last=last">
                      <div [formGroupName]="t" class="mb-1">
                        <!-- inputs row. One row for each period -->
                        <div class="form-row">
                          <div class="col-4">
                            <input class="form-control mr-2" formControlName="start_time"
                                   [value]="day.value.is_open ? time.value.start_time : ''"
                                   [readonly]="!day.value.is_open">
                          </div>
                          <div class="col-4">
                            <input class="form-control" formControlName="end_time"
                                   [value]="day.value.is_open ? time.value.end_time : ''"
                                   [readonly]="!day.value.is_open">
                          </div>
                          <div class="col-1 text-right">
                            <button *ngIf="day.value.is_open && day.controls.times.controls.length > 1"
                                    type="button" class="btn btn-outline-danger btn-sm"
                                    (click)="deleteTime(i, t)">
                              <i class="fa fa-trash-o" aria-hidden="true"></i>
                            </button>
                          </div>
                          <div class="col-3">
                            <button *ngIf="day.value.is_open && last" type="button"
                                    class="btn btn-outline-primary btn-sm" (click)="addTime(i)">
                              <i class="fa fa-plus-square-o" aria-hidden="true"></i> {{ 'period' | translate }}
                            </button>
                          </div>
                        </div>
                        <div
                          *ngIf="time.controls.start_time.invalid && (time.controls.start_time.dirty || time.controls.start_time.touched)"
                          class="text-danger pt-1">
                          <div *ngIf="time.controls.start_time.errors.required" translate>
                            Start time is required.
                          </div>
                          <div *ngIf="time.controls.start_time.errors.pattern" translate>
                            Start time format is not correct.
                          </div>
                        </div>
                        <div
                          *ngIf="time.controls.end_time.invalid && (time.controls.end_time.dirty || time.controls.end_time.touched)"
                          class="text-danger pt-1">
                          <div *ngIf="time.controls.end_time.errors.required" translate>
                            End time is required.
                          </div>
                          <div *ngIf="time.controls.end_time.errors.pattern" translate>
                            End time format is not correct.
                          </div>
                        </div>
                        <div *ngIf="time.invalid && (time.dirty || time.touched)" class="text-danger pt-1">
                          <div *ngIf="time.errors && time.errors.lessThan" translate>
                            End time is less than start time.
                          </div>
                        </div>
                      </div>
                    </li>
                  </ul>
                  <div *ngIf="day.invalid  && (day.dirty || day.touched)" class="text-danger pt-1">
                    <div *ngIf="day.errors && day.errors.rangeLessThan" translate>
                      The two periods are overlapping.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </tab>
        <tab>
          <ng-template tabHeading>
            <i class="fa fa-exclamation-triangle mr-2"></i>{{ 'Exceptions (holidays, etc.)' | translate }}
          </ng-template>
          <admin-libraries-exception-dates-list *ngIf="library" [exceptionDates]="library.exception_dates">
          </admin-libraries-exception-dates-list>
        </tab>
        <tab>
          <ng-template tabHeading>
            <i class="fa fa-envelope-o mr-2"></i>{{ 'Notification settings' | translate }}
          </ng-template>

          <div class="container" formArrayName="notification_settings">
            <div class="row mt-2" *ngFor="let setting of notificationSettings.controls; let i=index" [formGroupName]="i">
              <div class="col-3">
                <span style="min-width: 25px" class="d-inline-block">&nbsp;
                  <i *ngIf="setting.controls.type.value | notificationType:'patron'"
                    class="text-info fa fa-info-circle"></i>
                </span>
                <label class="font-weight-bold ml-2">{{ setting.controls.type.value | translate | ucfirst }}</label>
              </div>
              <div class="col">
                <input formControlName="email" class="form-control"
                       [id]="setting.controls.type.value + '-email'">
              </div>
              <div class="col-3" *ngIf="delayedNotificationTypes.includes(setting.controls.type.value)">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <div class="input-group-text"><i class="fa fa-clock-o"></i></div>
                  </div>
                  <input type="number" formControlName="delay" class="form-control" [id]="setting.controls.type.value + '-delay'">
                </div>
              </div>
            </div>
            <div class="row mt-3 border-top pt-2">
              <small class="col-1 text-warning font-weight-bold" translate>Note</small>
              <small class="col-11 text-secondary" translate>No notification is sent if the field is empty.</small>
              <i class="fa fa-info-circle text-info col-1"></i>
              <small class="col-11 text-secondary" translate>
                The notifications for patrons without e-mail are sent to this address.
              </small>
              <i class="fa fa-clock-o col-1"></i>
              <small class="col-11 text-secondary" translate>
                Sending how many minutes after the item is available
              </small>
            </div>
          </div>
        </tab>
        <tab>
          <ng-template tabHeading><i class="fa fa-university mr-2"></i>{{ 'Acquisition settings' | translate }}</ng-template>
          <div class="mt-3" formGroupName="acquisition_settings">
            <div class="card" formGroupName="shipping_informations">
              <div class="card-header">
                <i class="fa fa-truck"></i>
                {{ 'Shipping informations' | translate }}
              </div>
              <div class="card-body container">
                <!-- name + email + phone -->
                <div class="form-group form-row">
                  <label for="shipping-name" class="col-3 col-form-label" translate>Contact name</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-user"></i></span></div>
                    <input formControlName="name" id="shipping-name" class="form-control">
                  </div>
                </div>
                <div class="form-group form-row">
                  <label for="shipping-email" class="col-3 col-form-label" translate>Contact email</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text">@</span></div>
                    <input formControlName="email" id="shipping-email" class="form-control">
                  </div>
                </div>
                <div class="form-group form-row">
                  <label for="shipping-phone" class="col-3 col-form-label" translate>Contact phone</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-phone"></i></span></div>
                    <input formControlName="phone" id="shipping-phone" class="form-control">
                  </div>
                </div>
                <!-- Address -->
                <div formGroupName="address">
                  <div class="form-group form-row">
                    <label for="shipping-street" class="col-3 col-form-label" translate>Address</label>
                    <div class="col-9">
                      <input formControlName="street" class="form-control" id="shipping-street" placeholder="{{ 'Street' | translate }}">
                    </div>
                  </div>
                  <div class="form-group form-row">
                    <div class="col-3 offset-3">
                      <input formControlName="zip_code" class="form-control" id="shipping-zip-code" placeholder="{{ 'Zip code' | translate }}">
                    </div>
                    <div class="col">
                      <input formControlName="city" class="form-control" id="shipping-city" placeholder="{{ 'City' | translate }}">
                    </div>
                  </div>
                  <div class="form-group form-row">
                    <div class="col-9 offset-3">
                      <select formControlName="country" class="form-control" id="shipping-country">
                        <option value="" disabled translate>Select a country</option>
                        <option [ngValue]="code" *ngFor="let code of countries_iso_codes">{{ code | countryCodeTranslate }}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <!-- extra field -->
                <div class="form-group form-row">
                  <label for="shipping-extra" class="col-3 col-form-label" translate>Extra information</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-sticky-note-o"></i></span></div>
                    <input formControlName="extra" id="shipping-extra" class="form-control">
                  </div>
                </div>
              </div>
            </div>
            <div class="card mt-3" formGroupName="billing_informations">
              <div class="card-header">
                <i class="fa fa-money"></i>
                {{ 'Billing informations' | translate }}
              </div>
              <div class="card-body container">
                <!-- name + email + phone -->
                <div class="form-group form-row">
                  <label for="billing-name" class="col-3 col-form-label" translate>Contact name</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-user"></i></span></div>
                    <input formControlName="name" id="billing-name" class="form-control">
                  </div>
                </div>
                <div class="form-group form-row">
                  <label for="billing-email" class="col-3 col-form-label" translate>Contact email</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text">@</span></div>
                    <input formControlName="email" id="billing-email" class="form-control">
                  </div>
                </div>
                <div class="form-group form-row">
                  <label for="billing-phone" class="col-3 col-form-label" translate>Contact phone</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-phone"></i></span></div>
                    <input formControlName="phone" id="billing-phone" class="form-control">
                  </div>
                </div>
                <!-- Address -->
                <div formGroupName="address">
                  <div class="form-group form-row">
                    <label for="shipping-street" class="col-3 col-form-label" translate>Address</label>
                    <div class="col-9">
                      <input formControlName="street" class="form-control" id="billing-street" placeholder="{{ 'Street' | translate }}">
                    </div>
                  </div>
                  <div class="form-group form-row">
                    <div class="col-3 offset-3">
                      <input formControlName="zip_code" class="form-control" id="billing-zip-code" placeholder="{{ 'Zip code' | translate }}">
                    </div>
                    <div class="col">
                      <input formControlName="city" class="form-control" id="billing-city" placeholder="{{ 'City' | translate }}">
                    </div>
                  </div>
                  <div class="form-group form-row">
                    <div class="col-9 offset-3">
                      <select formControlName="country" class="form-control" id="billing-country">
                        <option value="" disabled translate>Select a country</option>
                        <option [ngValue]="code" *ngFor="let code of countries_iso_codes">{{ code | countryCodeTranslate }}</option>
                      </select>
                    </div>
                  </div>
                </div>
                <!-- extra field -->
                <div class="form-group form-row">
                  <label for="billing-extra" class="col-3 col-form-label" translate>Extra information</label>
                  <div class="col input-group">
                    <div class="input-group-prepend"><span class="input-group-text"><i class="fa fa-sticky-note-o"></i></span></div>
                    <input formControlName="extra" id="billing-extra" class="form-control">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </tab>
      </tabset>
      <div class="clearfix">
        <div class="float-right mt-4">
          <button class="btn btn-sm btn-outline-danger mr-1" (click)="onCancel($event)">
            <i class="fa fa-times"></i> {{ 'Cancel' | translate }}
          </button>
          <button type="submit" class="btn btn-sm btn-primary" [disabled]="libForm.invalid">
            <i class="fa fa-save"></i> {{ 'Save' | translate }}
          </button>
        </div>
      </div>
    </form>
  </ng-container>
</div>
