<!--
  RERO ILS UI
  Copyright (C) 2023-2024 RERO
  Copyright (C) 2023 UCLouvain

  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Affero General Public License as published by
  the Free Software Foundation, version 3 of the License.

  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU Affero General Public License for more details.

  You should have received a copy of the GNU Affero General Public License
  along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<div class="flex flex-col gap-2">
  <!-- PREVIEW TOP -->
  <ng-content select="[headerMessage]" />
  @if (previewPosition === 'top') {
    <ng-container
      [ngTemplateOutlet]="messagePreview"
      [ngTemplateOutletContext]="{preview, position: ['previewMessage']}"
    />
  }

  <h5 translate>Who do you want to send the message to?</h5>

  <!-- SUGGESTED EMAILS -->
  @if (emails.length > 0) {
    <p-panel>
      <ng-template #header>
        <div class="p-panel-title">
        @if (emails.length < 2) {
          {{ 'Suggested email address' | translate }}
        } @else {
          {{ 'Suggested email addresses' | translate }}
        }
        <small class="ml-1">(<span class="italic" translate>Drag and drop</span>)</small>
      </div>
      </ng-template>
      <div class="flex gap-1 mt-2">
        @for (email of emails; track email) {
          <p-tag
            pDraggable="emails"
            [style]="{cursor: 'grab'}"
            (onDragStart)="dragStart(email)"
            (onDragEnd)="dragEnd()"
            icon="pi pi-user"
            [value]="email"
          />
        }
      </div>
    </p-panel>
  }

  <!-- RECIPIENTS -->
  <p-panel [header]="'Recipients' | translate">
    <div class="grid grid-cols-12 gap-4 mt-2">
      @for (type of emailTypes; track type) {
        <div class="col-span-2" [class.field-required]="mandatoryEmailTypes.includes(type)">
          {{ ('email_' + type) | translate }}&nbsp;:
        </div>
        <div class="col-span-10">
          <p-autocomplete
            multiple
            fluid
            [typeahead]="false"
            [inputId]="type"
            pDroppable="emails"
            (onDrop)="drop($event)"
            [(ngModel)]="recipients[type]"
          />
        </div>
      }
    </div>
  </p-panel>

  <!-- PREVIEW BOTTOM -->
  @if (previewPosition === 'bottom') {
    <ng-container
      [ngTemplateOutlet]="messagePreview"
      [ngTemplateOutletContext]="{preview, position: ['previewBottomMessage']}"
    />
  }
</div>

<div class="flex justify-end gap-1 mt-2">
  <p-button severity="danger" outlined [label]="'Cancel'|translate" (onClick)="close()" aria-label="Close"/>
  <p-button [label]="'Confirm'|translate" [disabled]="!formValid()" (onClick)="confirm()" />
</div>

<ng-template #messagePreview let-preview="preview" let-position="position">
  <p-panel>
    <ng-template #header>
      <div class="grid grid-flow-row auto-rows-max">
        <div class="font-bold" translate>Message</div>
        <div class="italic text-sm">
          <ng-content [select]="position" />
        </div>
      </div>
    </ng-template>
    <pre class="max-h-[25rem] text-sm overflow-auto p-6 mt-2" [innerHTML]="preview.trim()"></pre>
  </p-panel>
</ng-template>
